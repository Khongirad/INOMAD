generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/@prisma/client-land"
}

datasource db {
  provider = "postgresql"
  url      = env("LAND_REGISTRY_DATABASE_URL")
}

// ============== LAND REGISTRY MODELS ==============

enum PropertyType {
  RESIDENTIAL
  COMMERCIAL
  AGRICULTURAL
  INDUSTRIAL
  MIXED_USE
  VACANT_LAND
}

enum OwnershipType {
  FULL_OWNERSHIP      // Only for citizens
  SHARED_OWNERSHIP    // Only for citizens (co-ownership)
  // Removed LEASEHOLD and USUFRUCT - these are now in separate Lease model
}

enum LeaseType {
  RESIDENTIAL_LEASE
  COMMERCIAL_LEASE
  AGRICULTURAL_LEASE
  LONG_TERM_LEASE  // 49+ years
}

enum TransactionType {
  INITIAL_REGISTRATION
  SALE               // Citizen to citizen only
  INHERITANCE        // Citizen to citizen
  GIFT               // Citizen to citizen
  COURT_ORDER
  MORTGAGE_REGISTRATION
  MORTGAGE_RELEASE
  LEASE_REGISTRATION  // Can involve foreigners
  LEASE_TERMINATION
}

enum TransactionStatus {
  PENDING
  VERIFIED
  COMPLETED
  REJECTED
  CANCELLED
}

// Land Plot (Cadastral Record)
model LandPlot {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Cadastral identification
  cadastralNumber String @unique
  
  // Location
  region       String
  district     String
  locality     String
  addressLine  String?
  
  // GPS Coordinates (GeoJSON polygon for boundaries)
  boundaries Json // GeoJSON format: {type: "Polygon", coordinates: [...]}
  centerLat  Decimal @db.Decimal(10, 7)
  centerLon  Decimal @db.Decimal(10, 7)

  // Plot characteristics
  area         Decimal @db.Decimal(12, 2) // Square meters
  propertyType PropertyType
  
  // Land use permissions
  permittedUse String[] // ["residential_construction", "agriculture", etc.]
  restrictions String[] // ["protected_zone", "heritage_site", etc.]

  // Valuation
  assessedValue Decimal? @db.Decimal(18, 2) // In Altan
  lastValuationDate DateTime?

  // Registry
  registeredDate DateTime @default(now())
  registeredBy   String // Registry officer userId

  // Relations
  properties   Property[]
  ownerships   Ownership[]
  leases       Lease[]  // Foreign leases
  transactions Transaction[]
  encumbrances Encumbrance[]

  @@index([cadastralNumber])
  @@index([region, district])
  @@index([propertyType])
}

// Building/Property on Land
model Property {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Parent land plot
  landPlotId String
  landPlot   LandPlot @relation(fields: [landPlotId], references: [id])

  // Property identification
  propertyNumber String @unique // Building-specific number
  
  // Type
  propertyType PropertyType
  
  // Building details
  buildingType String? // "house", "apartment", "warehouse", etc.
  floorNumber  Int? // For apartments
  totalFloors  Int?
  roomCount    Int?
  totalArea    Decimal? @db.Decimal(10, 2) // Square meters

  // Construction
  yearBuilt      Int?
  constructionMaterial String?
  
  // Valuation
  assessedValue     Decimal? @db.Decimal(18, 2)
  lastValuationDate DateTime?

  // Relations
  ownerships   Ownership[]
  leases       Lease[]  // Foreign leases
  transactions Transaction[]
  encumbrances Encumbrance[]

  @@index([landPlotId])
  @@index([propertyNumber])
  @@index([propertyType])
}

// Ownership Record (CITIZENS ONLY)
model Ownership {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // What is owned
  landPlotId String?
  landPlot   LandPlot? @relation(fields: [landPlotId], references: [id])
  
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  // Owner (reference to main DB user) - MUST BE CITIZEN
  ownerId String
  
  // CITIZENSHIP VERIFICATION
  // This field MUST be verified against main DB User.nationality before registration
  // Only users with nationality = "Siberian Confederation" can own land
  isCitizenVerified Boolean @default(false)
  verifiedAt        DateTime?
  
  // Ownership details
  ownershipType  OwnershipType
  ownershipShare Decimal @default(100) @db.Decimal(5, 2) // Percentage (0-100)
  
  // Joint ownership (all co-owners MUST be citizens)
  isJointOwnership Boolean @default(false)
  jointOwnerIds    String[] // Other owner userIds (must all be citizens)

  // Timing
  acquisitionDate DateTime @default(now())
  
  // Certificate
  certificateNumber String @unique
  issuedDate        DateTime @default(now())

  // Status
  isActive Boolean @default(true) // False after transfer

  @@index([ownerId])
  @@index([landPlotId])
  @@index([propertyId])
  @@index([isActive])
  @@index([isCitizenVerified])
}

// Property Transaction History
model Transaction {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // What was transacted
  landPlotId String?
  landPlot   LandPlot? @relation(fields: [landPlotId], references: [id])
  
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  // Transaction details
  transactionType TransactionType
  status          TransactionStatus @default(PENDING)

  // Parties
  sellerId String? // Previous owner userId
  buyerId  String? // New owner userId
  
  // Financial
  transactionAmount Decimal? @db.Decimal(18, 2) // In Altan
  paymentTxHash     String? // Blockchain transaction hash
  
  // Documents
  contractHash String? // IPFS or blockchain hash
  documents    String[] // Document URLs/hashes

  // Registry processing
  verifiedBy   String? // Registry officer userId
  verifiedAt   DateTime?
  completedAt  DateTime?
  
  // Smart contract
  blockchainTxHash String? // On-chain ownership transfer

  @@index([landPlotId])
  @@index([propertyId])
  @@index([sellerId])
  @@index([buyerId])
  @@index([status])
  @@index([createdAt])
}

// Mortgages and Liens
model Encumbrance {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Encumbered property
  landPlotId String?
  landPlot   LandPlot? @relation(fields: [landPlotId], references: [id])
  
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  // Type
  encumbranceType String // "MORTGAGE", "LIEN", "EASEMENT", "RESTRICTION"
  
  // Creditor/Beneficiary
  creditorName String
  creditorId   String? // If registered user
  
  // Debtor
  debtorId String // Owner userId
  
  // Financial (for mortgages)
  principalAmount Decimal? @db.Decimal(18, 2)
  interestRate    Decimal? @db.Decimal(5, 2) // Annual percentage
  
  // Timing
  startDate   DateTime @default(now())
  maturityDate DateTime?
  
  // Status
  isActive Boolean @default(true)
  releasedAt DateTime?
  releasedBy String? // Registry officer userId

  // Documents
  documentHash String?

  @@index([landPlotId])
  @@index([propertyId])
  @@index([debtorId])
  @@index([creditorId])
  @@index([isActive])
}

// Lease Agreement (FOR FOREIGNERS - Cannot own, only lease)
model Lease {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Leased property
  landPlotId String?
  landPlot   LandPlot? @relation(fields: [landPlotId], references: [id])
  
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  // Lessor (owner) - MUST BE CITIZEN
  lessorId String // Owner userId (citizen)
  
  // Lessee (tenant) - CAN BE FOREIGNER
  lesseeId String // Tenant userId
  
  // FOREIGNER FLAG
  // If lessee IS a citizen, they can still lease
  // But if lessee is NOT a citizen, this is their ONLY option
  isForeignLessee Boolean @default(false)
  
  // Lease details
  leaseType  LeaseType
  startDate  DateTime
  endDate    DateTime
  
  // Automatic renewal
  isAutoRenew Boolean @default(false)
  renewalTermMonths Int? // If auto-renew enabled
  
  // Financial
  monthlyRent   Decimal @db.Decimal(18, 2) // In Altan
  depositAmount Decimal @db.Decimal(18, 2)
  
  // Payment status
  isPaid       Boolean @default(false)
  lastPayment  DateTime?
  nextPayment  DateTime?
  
  // Terms
  terms        String @db.Text
  restrictions String[] // Usage restrictions
  
  // Status
  status String @default("ACTIVE") // ACTIVE, EXPIRED, TERMINATED, PENDING
  
  // Termination
  terminatedAt DateTime?
  terminatedBy String? // Who terminated (lessor or lessee userId)
  terminationReason String?

  // Registry
  registeredBy String // Registry officer userId
  registeredAt DateTime @default(now())
  
  // Certificate
  leaseNumber String @unique
  
  @@index([lessorId])
  @@index([lesseeId])
  @@index([landPlotId])
  @@index([propertyId])
  @@index([status])
  @@index([isForeignLessee])
  @@index([endDate])
}

// Public Cadastral Search Index
model PublicCadastralIndex {
  id        String   @id @default(uuid())

  // Searchable info (public)
  cadastralNumber String @unique
  propertyType    PropertyType
  region          String
  district        String
  
  // Limited location (no exact address)
  approximateLocation String // "North district, residential area"
  
  // Status only
  hasActiveOwnership Boolean @default(true)
  hasEncumbrances    Boolean @default(false)
  
  // NO owner info, NO exact location, NO transaction amounts

  @@index([cadastralNumber])
  @@index([region, district])
  @@index([propertyType])
}
