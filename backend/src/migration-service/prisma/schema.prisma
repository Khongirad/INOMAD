generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/@prisma/client-migration"
}

datasource db {
  provider = "postgresql"
  url      = env("MIGRATION_SERVICE_DATABASE_URL")
}

// ============== MIGRATION SERVICE MODELS ==============

enum AccessRole {
  MIGRATION_OFFICER    // Full access to all data
  LAW_ENFORCEMENT      // Limited access (lookup only)
  COURT_WARRANT        // Temporary full access via warrant
  APPLICANT            // Own data only
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  ISSUED
}

enum DocumentType {
  IDENTITY_CARD
  BIRTH_CERTIFICATE
  RESIDENCE_PROOF
  PHOTO
  BIOMETRIC_DATA
  OTHER
}

// Passport Application
model PassportApplication {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Applicant (reference to main DB user)
  userId String @unique

  // Application status
  status ApplicationStatus @default(DRAFT)

  // Personal Information
  fullName    String
  dateOfBirth DateTime
  placeOfBirth String
  nationality  String @default("Siberian Confederation")
  
  // Biography (private, officer-only access)
  biography String @db.Text
  
  // Contact
  currentAddress String
  email          String?
  phone          String?

  // Passport Details (after issuance)
  passportNumber String? @unique
  issueDate      DateTime?
  expiryDate     DateTime?

  // Review
  reviewedBy     String? // Migration officer userId
  reviewedAt     DateTime?
  rejectionReason String?

  // Relations
  documents Document[]
  accessLogs AccessLog[]

  @@index([userId])
  @@index([passportNumber])
  @@index([fullName])
  @@index([status])
  @@index([issueDate])
}

// Encrypted Document Storage
model Document {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  applicationId String
  application   PassportApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // Document metadata
  documentType DocumentType
  fileName     String
  fileSize     Int // bytes
  mimeType     String

  // Storage
  encryptedPath String // Path to encrypted file
  encryptionKey String // Encrypted with service master key
  checksum      String // For integrity verification

  // Upload info
  uploadedBy String // userId
  uploadedAt DateTime @default(now())

  @@index([applicationId])
  @@index([documentType])
}

// Warrant System for Law Enforcement Access
model Warrant {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Requesting officer
  requestedBy String // Law enforcement userId
  agency      String // "Border Control", "Police", "Special Services"
  
  // Warrant details
  warrantNumber String @unique
  courtName     String
  judgeName     String
  reason        String @db.Text

  // Target
  targetUserId String

  // Status
  status    String @default("PENDING") // PENDING, APPROVED, REJECTED, EXPIRED
  approvedBy String? // Admin userId who approved
  approvedAt DateTime?
  
  // Access period
  validFrom DateTime?
  validUntil DateTime?

  // Audit
  accessCount Int @default(0)
  lastAccessed DateTime?

  @@index([targetUserId])
  @@index([requestedBy])
  @@index([status])
  @@index([validUntil])
}

// Access Audit Log
model AccessLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())

  // Who accessed
  accessorId String // userId
  accessorRole AccessRole

  // What was accessed
  applicationId String?
  application   PassportApplication? @relation(fields: [applicationId], references: [id])

  // Access details
  action String // "VIEW_FULL", "VIEW_LIMITED", "DOWNLOAD_DOCUMENT", "UPDATE"
  
  // Warrant (if applicable)
  warrantId String?

  // Audit trail
  ipAddress String?
  userAgent String?
  
  // What data was accessed
  accessedFields String[] // ["biography", "documents", "fullName"]

  @@index([accessorId])
  @@index([applicationId])
  @@index([timestamp])
  @@index([accessorRole])
}

// Bank Verification Integration
model BankVerification {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId String

  // Bank details
  bankCode String
  bankName String
  
  // Verification result
  isVerified     Boolean @default(false)
  verifiedAt     DateTime?
  verificationRef String? // Bank's internal reference
  
  // Officer who processed
  processedBy String?

  @@index([userId])
  @@index([bankCode])
}
