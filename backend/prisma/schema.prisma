generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id     String @id @default(uuid())
  seatId String @unique

  // Authentication (Gates of Khural)
  username     String? @unique
  passwordHash String?
  email        String? @unique

  // Legal Status
  hasAcceptedTOS          Boolean   @default(false)
  tosAcceptedAt           DateTime?
  hasAcceptedConstitution Boolean   @default(false)
  constitutionAcceptedAt  DateTime?
  isLegalSubject          Boolean   @default(false) // True after constitution acceptance

  role               UserRole           @default(CITIZEN)
  walletStatus       WalletStatus       @default(LOCKED)
  birthPlace         Json?
  currentAddress     Json?
  ethnicity          String[]
  clan               String?
  verificationStatus VerificationStatus @default(DRAFT)
  isSuperVerified    Boolean            @default(false)
  superVerifiedBy    String?
  isFrozen           Boolean            @default(false) // For Creator to freeze admin accounts
  frozenAt           DateTime?
  frozenBy           String? // Creator userId who froze this account

  // Identity Information (Sprint 3 - Government Services Integration)
  dateOfBirth        DateTime? // Required for ZAGS marriage eligibility (18+)
  nationality        String?   @default("Siberian Confederation") // For Land Registry citizenship checks
  passportNumber     String?   @unique // Links to Migration Service passport applications
  passportIssueDate  DateTime? // Passport validity tracking
  passportExpiryDate DateTime? // Passport expiry for renewals

  // Verification Chain
  isVerified            Boolean            @default(false)
  verifiedAt            DateTime?
  verificationsReceived UserVerification[] @relation("VerifiedUser")
  verificationsGiven    UserVerification[] @relation("Verifier")
  verificationCount     Int                @default(0)
  maxVerifications      Int                @default(5)

  // Tiered Verification System (NEW)
  verificationLevel      VerificationLevel @default(UNVERIFIED)
  verificationLevelSetAt DateTime?
  verificationLevelSetBy String? // Admin userId who set the level
  totalEmitted           Decimal           @default(0) @db.Decimal(18, 2)
  arbanVerifiedAt        DateTime?
  zunVerifiedAt          DateTime?
  fullyVerifiedAt        DateTime?

  // Timeline
  eventsAsActor  TimelineEvent[] @relation("EventActor")
  eventsAsTarget TimelineEvent[] @relation("EventTarget")

  // Historical records
  historicalRecords HistoricalRecord[] @relation("HistoricalAuthor")

  // Hierarchical membership
  familyId       String?
  clanId         String?
  currentArbanId String?
  hordeId        String?
  nationId       String?
  organizationId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  walletAddress  String?  @unique

  // MPC Wallet (Phase 2)
  walletMigrated Boolean    @default(false)
  mpcWallet      MPCWallet?

  altanLedger             AltanLedger?
  sentTransactions        AltanTransaction[]   @relation("SentTransactions")
  receivedTransactions    AltanTransaction[]   @relation("ReceivedTransactions")
  auditLogs               AuditLog[]
  sessions                AuthSession[]
  bankLink                BankLink?
  councilVotes            CouncilVote[]        @relation("CouncilVoter")
  guildMemberships        GuildMember[]
  proposedHistoryVersions KhuralEventVersion[] @relation("HistoryProposer")
  khuralSeats             KhuralSeat[]
  tasksAssigned           Task[]               @relation("TaskAssignee")
  tasksCreated            Task[]               @relation("TaskCreator")
  // Transparency: Activities performed by this user
  activitiesPerformed     ActivityEntry[]      @relation("UserActivities")
  approvalsGiven          UnlockApproval[]
  unlockRequest           UnlockRequest?
  ubiPayments             UbiPayment[]         // UBI payment history
  organization            Guild?               @relation("OrganizationMembers", fields: [organizationId], references: [id])

  // Legacy verification support
  oldVerificationsReceived Verification[] @relation("TargetUser")
  oldVerificationsIssued   Verification[] @relation("VerifierUser")

  // Legislative Relations
  proposalsCreated Proposal[]       @relation("ProposalCreator")
  votesCast        Vote[]           @relation("VoteCaster")
  khuralDelegates  KhuralDelegate[] @relation("KhuralDelegate")

  // Chancellery & Archive Relations (NOTE: Old Document models removed)
  // documentsCreated  Document[]          @relation("DocumentCreator") // REMOVED - see State Archive system
  // documentsSigned   DocumentSignature[] @relation("DocumentSigner")  // REMOVED - see State Archive system
  questsGiven       Quest[]            @relation("QuestGiver")
  questsTaken       Quest[]            @relation("QuestTaker")
  reputationProfile ReputationProfile? @relation("UserReputation")

  // Guild & Organization Relations
  organizationsLed        Organization[]       @relation("OrganizationLeader")
  organizationMemberships OrganizationMember[] @relation("OrganizationMemberships")
  memberInvitations       OrganizationMember[] @relation("MemberInvitations")
  organizationRatings     OrganizationRating[] @relation("OrganizationRatingsGiven")

  // Education & Invitations
  educationVerifications   EducationVerification[] @relation("EducationVerifications")
  educationRecommendations EducationVerification[] @relation("EducationRecommendations")
  invitationsSent          GuildInvitation[]       @relation("InvitationsSent")
  invitationsReceived      GuildInvitation[]       @relation("InvitationsReceived")

  // Elections
  electionsWon        Election[]          @relation("ElectionsWon")
  electionCandidacies ElectionCandidate[] @relation("ElectionCandidacies")

  // Calendar
  calendarEvents CalendarEvent[]
  calendarNotes  CalendarNote[]

  // Tiered Verification Relations
  verificationRequests         VerificationRequest[]     @relation("Requester")
  verificationRequestsReviewed VerificationRequest[]     @relation("Reviewer")
  arbanVerificationsGiven      ArbanMutualVerification[] @relation("ArbanVerifier")
  arbanVerificationsReceived   ArbanMutualVerification[] @relation("ArbanVerified")

  // Initial ALTAN Distribution
  distribution UserDistribution?

  // State Archive & Document System
  templatesCreated      DocumentTemplate[]     @relation("TemplateCreator")
  documentsIssued       DocumentContract[]     @relation("DocumentIssuer")
  documentsReceived     DocumentContract[]     @relation("DocumentRecipient")
  documentsArchived     DocumentContract[]     @relation("DocumentArchivist")
  documentsIntermediate DocumentContract[]     @relation("DocumentIntermediary") // Broker/intermediary role
  documentStageChanges  DocumentStageHistory[] @relation("StageChanger")
  documentSignatures    DocumentSignature[]    @relation("DocumentSigner")
  notaryRecords         NotarizationRecord[]   @relation("NotaryRecords")
  legalCertifications   LegalCertification[]   @relation("LegalCertifications")
  documentAccess        DocumentAccessLog[]    @relation("DocumentAccess")

  // Banking System
  banksDirected Bank[] @relation("BankDirector")

  // Migration Service (Passport Office)
  passportApplications PassportApplication[] @relation("PassportApplicant")

  // ZAGS (Civil Registry)
  marriagesAsSpouse1 Marriage[]        @relation("Spouse1Marriages")
  marriagesAsSpouse2 Marriage[]        @relation("Spouse2Marriages")
  marriageConsents   MarriageConsent[] @relation("MarriageConsents")
  divorcesInitiated  ZagsDivorce[]     @relation("DivorceInitiator")

  // Land Registry
  landPlotsRegistered LandPlot[]        @relation("LandRegistrar")
  landOwnerships      LandOwnership[]   @relation("LandOwner")
  landLeases          LandLease[]       @relation("LandLessee")
  landSales           LandTransaction[] @relation("LandSeller")
  landPurchases       LandTransaction[] @relation("LandBuyer")

  @@index([seatId])
  @@index([organizationId])
  @@index([verificationStatus])
}

model AuthNonce {
  id        String   @id @default(uuid())
  address   String
  nonce     String   @unique
  expiresAt DateTime
  consumed  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([address])
  @@index([expiresAt])
}

model AuthSession {
  id           String   @id @default(uuid())
  userId       String
  jti          String   @unique
  refreshToken String?  @unique
  expiresAt    DateTime
  lastUsedAt   DateTime @default(now())
  ipAddress    String?
  userAgent    String?
  isRevoked    Boolean  @default(false)
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([jti])
}

model BankLink {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userId    String   @unique
  bankCode  String
  bankRef   String
  status    String   @default("ACTIVE")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([bankCode])
}

// Legacy verification (keeping for backwards compatibility)
model Verification {
  id             String   @id @default(uuid())
  targetUserId   String
  verifierUserId String
  createdAt      DateTime @default(now())
  targetUser     User     @relation("TargetUser", fields: [targetUserId], references: [id])
  verifierUser   User     @relation("VerifierUser", fields: [verifierUserId], references: [id])

  @@unique([targetUserId, verifierUserId])
}

// Enhanced verification with chain tracking
model UserVerification {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Who was verified
  verifiedUserId String
  verifiedUser   User   @relation("VerifiedUser", fields: [verifiedUserId], references: [id])

  // Who performed the verification
  verifierId String
  verifier   User   @relation("Verifier", fields: [verifierId], references: [id])

  // Verification details
  verificationMethod String // "ADMIN", "USER_REFERRAL"
  notes              String?

  // Audit trail
  ipAddress String?
  userAgent String?
  location  String? // Geographic location

  // Link to timeline event
  timelineEventId String?        @unique
  timelineEvent   TimelineEvent? @relation(fields: [timelineEventId], references: [id])

  @@unique([verifiedUserId, verifierId])
  @@index([verifierId])
  @@index([verifiedUserId])
  @@index([createdAt])
}

// Verification Request for Zun/Full upgrades
model VerificationRequest {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Requester
  requesterId String
  requester   User   @relation("Requester", fields: [requesterId], references: [id])

  // Request details
  requestedLevel      VerificationLevel
  justification       String            @db.Text
  supportingDocuments Json? // Array of document URLs/references

  // Status
  status       String    @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewedById String?
  reviewedBy   User?     @relation("Reviewer", fields: [reviewedById], references: [id])
  reviewNotes  String?   @db.Text
  reviewedAt   DateTime?

  @@index([requesterId])
  @@index([status])
  @@index([createdAt])
}

// Arban Mutual Verification (each member verifies others)
model ArbanMutualVerification {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Arban context
  arbanId String
  arban   Guild  @relation("ArbanVerifications", fields: [arbanId], references: [id])

  // Verifier (member doing the verification)
  verifierId String
  verifier   User   @relation("ArbanVerifier", fields: [verifierId], references: [id])

  // Verified (member being verified)
  verifiedId String
  verified   User   @relation("ArbanVerified", fields: [verifiedId], references: [id])

  // Verification details
  isVerified Boolean  @default(true)
  notes      String?  @db.Text
  verifiedAt DateTime @default(now())

  @@unique([arbanId, verifierId, verifiedId])
  @@index([arbanId])
  @@index([verifierId])
  @@index([verifiedId])
}

// ============================
// INITIAL ALTAN DISTRIBUTION SYSTEM
// ============================

/// Distribution Pool for tracking the 2.1 trillion ALTAN initial emission
/// This pool is created once when Central Bank performs the initial emission
/// and tracks how the ALTAN is allocated across different purposes
model DistributionPool {
  id String @id @default(uuid())

  // Total amounts from initial emission
  totalEmission Decimal @db.Decimal(20, 2) // 2.1 trillion ALTAN
  citizenPool   Decimal @db.Decimal(20, 2) // e.g., 60% for citizens
  stateTreasury Decimal @db.Decimal(20, 2) // e.g., 30% for state
  peoplesFund   Decimal @db.Decimal(20, 2) // e.g., 10% for people's fund

  // Tracking
  totalDistributed Decimal @default(0) @db.Decimal(20, 2) // Total distributed so far
  totalCitizens    Int     @default(0) // Number of registered citizens
  perCitizenShare  Decimal @db.Decimal(18, 2) // Calculated: citizenPool / estimatedCitizens

  // Status
  status         String   @default("ACTIVE") // ACTIVE, DEPLETED, SUSPENDED
  emissionDate   DateTime // When CB performed the emission
  emissionTxHash String? // Blockchain transaction hash (if applicable)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

/// Per-user distribution tracking
/// Tracks how much of their allocation each citizen has received
/// based on their verification level progression
model UserDistribution {
  id String @id @default(uuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Citizen's total allocation from pool
  totalAllocation Decimal @db.Decimal(18, 2) // Their full share (~8,690 ALTAN example)

  // Received amounts by verification level
  unverifiedReceived    Decimal @default(0) @db.Decimal(18, 2) // 100 ALTAN on registration
  arbanVerifiedReceived Decimal @default(0) @db.Decimal(18, 2) // 900 more (total 1,000)
  zunReceived           Decimal @default(0) @db.Decimal(18, 2) // 9,000 more (total 10,000)
  fullyReceived         Decimal @default(0) @db.Decimal(18, 2) // Remaining allocation

  // Totals
  totalReceived    Decimal @db.Decimal(18, 2) // Sum of all received
  remainingBalance Decimal @db.Decimal(18, 2) // totalAllocation - totalReceived

  // Distribution events
  firstDistributionAt DateTime? // When they first received ALTAN
  lastDistributionAt  DateTime? // Most recent distribution
  fullyDistributedAt  DateTime? // When they received full allocation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([fullyDistributedAt])
}

// ============================
// STATE ARCHIVE & DOCUMENT SYSTEM
// ============================

/// Document templates managed by State Archive
/// Universal constructor for all official documents
model DocumentTemplate {
  id String @id @default(uuid())

  // Template identification
  code     String  @unique // "BANKING_LICENSE_001", "EMISSION_PROTOCOL_001"
  name     String // "Banking License"
  nameRu   String? // "Лицензия на банковскую деятельность"
  category String // "Banking", "Emission", "Legal"
  version  String  @default("1.0")

  // Template structure (JSON schema)
  templateSchema  Json // Field definitions with types
  requiredFields  String[] // ["bank_name", "address", "tax_id"]
  optionalFields  String[]
  validationRules Json? // Custom validation logic

  // Template content (English)
  contentTemplate String  @db.Text // Mustache/Handlebars template
  headerTemplate  String? @db.Text
  footerTemplate  String? @db.Text

  // Workflow configuration
  requiredSignatures String[] // ["CB_GOVERNOR", "NOTARY", "LAWYER"]
  stagesRequired     String[] // ["DRAFT", "SIGNED", "NOTARIZED", "CERTIFIED", "ARCHIVED"]

  // Blockchain config
  blockchainEnabled Boolean @default(true)
  contractTemplate  String? @db.Text // Smart contract code template

  // Archive management
  status      String   @default("ACTIVE") // ACTIVE, DEPRECATED, ARCHIVED
  createdById String
  createdBy   User     @relation("TemplateCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Generated documents
  documents DocumentContract[]

  @@index([category, status])
  @@index([code])
}

/// Document smart contracts - each official document is a blockchain contract
/// Tracks document stages in real-time
model DocumentContract {
  id String @id @default(uuid())

  // Document identification
  documentNumber String  @unique // "BL-001/2026", "EP-001/2026"
  registryNumber String? @unique // State registry number
  archiveNumber  String? @unique // Archive catalog number

  // Template reference
  templateId String
  template   DocumentTemplate @relation(fields: [templateId], references: [id])

  // Document data
  title            String
  titleRu          String?
  variables        Json // Template variables filled in
  generatedContent String  @db.Text // Final rendered document (English)
  attachments      Json? // Additional files/images

  // Parties involved
  issuerId    String // CB Governor, etc.
  issuer      User    @relation("DocumentIssuer", fields: [issuerId], references: [id])
  recipientId String? // Bank, etc.
  recipient   User?   @relation("DocumentRecipient", fields: [recipientId], references: [id])

  // Intermediary/Broker (optional)
  intermediaryId         String? // Broker facilitating the agreement
  intermediary           User?    @relation("DocumentIntermediary", fields: [intermediaryId], references: [id])
  intermediaryCommission Decimal? @db.Decimal(5, 4) // Commission percentage (0.0001 to 0.0100 = 0.01% to 1%)
  transactionAmount      Decimal? @db.Decimal(18, 6) // Deal amount (if monetary transaction)

  // Current state
  currentStage DocumentStage  @default(DRAFT)
  status       DocumentStatus @default(ACTIVE)

  // Stage history
  stages DocumentStageHistory[]

  // Signatures (multi-sig)
  signatures DocumentSignature[]

  // Notarization
  notarization NotarizationRecord?

  // Legal certification
  legalCert LegalCertification?

  // Blockchain smart contract
  blockchainTxHash String? // Contract deployment TX
  contractAddress  String? // Smart contract address
  blockchainData   Json? // Additional blockchain metadata

  // Integrity verification
  documentHash  String // SHA-256 of content
  hashTimestamp DateTime @default(now())

  // Archiving
  archivedAt   DateTime?
  archivedById String?
  archivedBy   User?     @relation("DocumentArchivist", fields: [archivedById], references: [id])

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Access control
  accessLog DocumentAccessLog[]

  // Banking reverse relations
  bankLicense              Bank? @relation("BankLicense")
  bankCorrespondentAccount Bank? @relation("CorrespondentAgreement")

  @@index([currentStage, status])
  @@index([documentNumber])
  @@index([templateId])
}

/// Document stages - real-time tracking
/// Each stage change creates a new history record
model DocumentStageHistory {
  id String @id @default(uuid())

  documentId String
  document   DocumentContract @relation(fields: [documentId], references: [id], onDelete: Cascade)

  fromStage DocumentStage?
  toStage   DocumentStage

  triggeredById String
  triggeredBy   User   @relation("StageChanger", fields: [triggeredById], references: [id])

  notes     String?  @db.Text
  timestamp DateTime @default(now())

  // Blockchain event
  blockchainTx String? // TX hash for stage change

  @@index([documentId, timestamp])
}

/// Digital signatures on documents
/// GOST-compliant ECDSA signatures
model DocumentSignature {
  id String @id @default(uuid())

  documentId String
  document   DocumentContract @relation(fields: [documentId], references: [id], onDelete: Cascade)

  signerId   String
  signer     User       @relation("DocumentSigner", fields: [signerId], references: [id])
  signerRole SignerRole

  // Digital signature data
  signature String // ECDSA signature (hex)
  publicKey String // Signer's public key
  algorithm String @default("ECDSA-secp256k1")

  // Verification
  verified   Boolean   @default(false)
  verifiedAt DateTime?

  // Context
  signedAt  DateTime @default(now())
  ipAddress String
  userAgent String?

  @@index([documentId])
  @@index([signerId])
}

/// Notarization records - managed by State Archive notaries
model NotarizationRecord {
  id String @id @default(uuid())

  documentId String           @unique
  document   DocumentContract @relation(fields: [documentId], references: [id], onDelete: Cascade)

  notaryId String
  notary   User   @relation("NotaryRecords", fields: [notaryId], references: [id])

  // Notarial data
  registryNumber String  @unique // Notarial registry number
  notes          String? @db.Text
  sealImage      String? // Digital seal/stamp

  // Signature
  signature String
  publicKey String

  notarizedAt DateTime @default(now())

  @@index([notaryId])
}

/// Legal certification - managed by State Archive lawyers
model LegalCertification {
  id String @id @default(uuid())

  documentId String           @unique
  document   DocumentContract @relation(fields: [documentId], references: [id], onDelete: Cascade)

  lawyerId String
  lawyer   User   @relation("LegalCertifications", fields: [lawyerId], references: [id])

  // Legal opinion
  opinion   String  @db.Text // Legal analysis (English)
  opinionRu String? @db.Text // Russian version if needed
  compliant Boolean // Meets legal requirements
  notes     String? @db.Text

  // Signature
  signature String
  publicKey String

  certifiedAt DateTime @default(now())

  @@index([lawyerId])
}

/// Document access log - audit trail
model DocumentAccessLog {
  id String @id @default(uuid())

  documentId String
  document   DocumentContract @relation(fields: [documentId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("DocumentAccess", fields: [userId], references: [id])

  action AccessAction // VIEW, DOWNLOAD, PRINT, MODIFY
  reason String? // Why accessed

  timestamp DateTime @default(now())
  ipAddress String
  userAgent String?

  @@index([documentId, timestamp])
  @@index([userId])
}

// Enums for document system
enum DocumentStage {
  DRAFT // Being prepared
  PENDING_REVIEW // Submitted for review
  SIGNED // Signed by issuer
  PENDING_NOTARIZATION
  NOTARIZED // Notary approved
  PENDING_LEGAL
  CERTIFIED // Lawyer certified
  ARCHIVED // In State Archive
  PUBLISHED // Public access
}

enum DocumentStatus {
  ACTIVE
  SUSPENDED
  REVOKED
  EXPIRED
  ARCHIVED
}

enum SignerRole {
  CREATOR
  PARTY_A // First party in bilateral agreement
  PARTY_B // Second party in bilateral agreement
  CB_GOVERNOR
  NOTARY
  STATE_LAWYER
  BANK_DIRECTOR
  WITNESS
  OFFICER
  INTERMEDIARY // Broker/intermediary with commission (0.1-1%)
}

enum AccessAction {
  VIEW
  DOWNLOAD
  PRINT
  MODIFY
  SIGN
  ARCHIVE
}

// =====================================
// BANKING SYSTEM
// =====================================

model Bank {
  id String @id @default(cuid())

  // Basic Information
  name         String
  nameRu       String?
  legalAddress String
  taxId        String  @unique

  // Banking License
  licenseNumber     String?           @unique // e.g., "BL-001/2026"
  licenseDocumentId String?           @unique
  licenseDocument   DocumentContract? @relation("BankLicense", fields: [licenseDocumentId], references: [id])
  licenseStatus     BankLicenseStatus @default(PENDING)
  licenseIssuedAt   DateTime?

  // Correspondent Account (with Central Bank)
  correspondentAccountNumber String?           @unique
  correspondentAgreementId   String?           @unique
  correspondentAgreement     DocumentContract? @relation("CorrespondentAgreement", fields: [correspondentAgreementId], references: [id])

  // Leadership
  directorId String?
  director   User?   @relation("BankDirector", fields: [directorId], references: [id])

  // Operational Status
  operationalStatus BankStatus @default(PENDING_LICENSE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([licenseStatus])
  @@index([operationalStatus])
  @@index([taxId])
}

enum BankLicenseStatus {
  PENDING // Application submitted
  APPROVED // Approved by CB
  ISSUED // License issued
  SUSPENDED // Operations suspended
  REVOKED // License revoked
}

enum BankStatus {
  PENDING_LICENSE // Awaiting banking license
  LICENSED // License issued
  OPERATIONAL // Fully operational with correspondent account
  SUSPENDED // Operations suspended
  DISSOLVED // Bank dissolved
}

// Timeline Event System
model TimelineEvent {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Event details
  type        EventType
  scope       EventScope @default(INDIVIDUAL)
  title       String
  description String?

  // Actor (who performed the action)
  actorId String?
  actor   User?   @relation("EventActor", fields: [actorId], references: [id])

  // Target (who/what was affected)
  targetId String?
  target   User?   @relation("EventTarget", fields: [targetId], references: [id])

  // Location & Time
  location String?
  timezone String? @default("UTC")

  // Hierarchical context
  familyId String?
  clanId   String?
  arbanId  String?
  hordeId  String?
  nationId String?

  // Legal significance
  isLegalContract Boolean  @default(false)
  contractHash    String?
  witnessIds      String[]

  // Metadata
  metadata  Json?
  ipAddress String?
  userAgent String?

  // Relations
  verification UserVerification?
  taskId       String?
  // Document     Document?  // REMOVED - old Chancellery model removed

  @@index([actorId, createdAt])
  @@index([targetId, createdAt])
  @@index([type, scope])
  @@index([createdAt])
  @@index([arbanId])
  @@index([clanId])
}

// Historical Records (written by specialists)
model HistoricalRecord {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Scope of history
  scope   EventScope
  scopeId String

  // Time period
  periodStart DateTime
  periodEnd   DateTime?

  // Content
  title     String
  narrative String // Markdown text

  // Authorship
  authorId String
  author   User   @relation("HistoricalAuthor", fields: [authorId], references: [id])

  // Review status
  isPublished Boolean   @default(false)
  reviewedBy  String?
  reviewedAt  DateTime?

  // Related events
  eventIds String[]

  @@index([scope, scopeId])
  @@index([createdAt])
  @@index([isPublished])
}

// ============== CALENDAR SYSTEM ==============

model CalendarEvent {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Event details
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  allDay      Boolean   @default(false)

  // Location
  location String?

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Visibility
  isPublic Boolean @default(false)

  // Categories/Tags
  category String? // "WORK", "PERSONAL", "KHURAL", "MEETING", etc.
  tags     String[]

  // Reminders
  reminderMinutes Int? // Minutes before event to remind

  // Link to timeline (optional)
  timelineEventId String?

  // Color coding
  color String? @default("#3B82F6")

  @@index([userId, startDate])
  @@index([startDate])
  @@index([userId])
}

model CalendarNote {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Note details
  title   String?
  content String // Markdown supported
  date    DateTime // Date this note is attached to

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Tags
  tags String[]

  // Color
  color String? @default("#F59E0B")

  @@index([userId, date])
  @@index([userId])
}

// ============== CHANCELLERY & ARCHIVE SYSTEM ==============
// NOTE: Old Document models removed - replaced by State Archive DocumentContract system
// (See "STATE ARCHIVE & DOCUMENT SYSTEM" section above)

// Quest/Task System (WoW-style)
model Quest {
  id String @id @default(uuid())

  // Parties
  giverId String
  giver   User    @relation("QuestGiver", fields: [giverId], references: [id])
  takerId String?
  taker   User?   @relation("QuestTaker", fields: [takerId], references: [id])

  // Quest details
  title       String
  description String @db.Text
  objectives  Json[] // [{description, completed, evidence?}]

  // Requirements
  requirements  Json? // {skills: [], minReputation: 50}
  minReputation Int?

  // Rewards
  rewardAltan    Decimal? @db.Decimal(18, 4)
  rewardItems    Json? // NFTs, badges
  reputationGain Int?

  // Timing
  deadline          DateTime?
  estimatedDuration Int? // minutes

  // Progress
  status   QuestStatus @default(OPEN)
  progress Int         @default(0) // 0-100%

  // Evidence
  submissions Json[] // [{url, description, timestamp}]

  // Ratings (after completion)
  giverRating   Int? // 1-5
  takerRating   Int?
  giverFeedback String?
  takerFeedback String?

  // Optional integration with formal docs
  assignmentDocId String? @unique
  // assignmentDoc   Document? @relation(fields: [assignmentDocId], references: [id])  // REMOVED - old Document model
  completionDocId String?

  // Lifecycle timestamps
  acceptedAt  DateTime?
  startedAt   DateTime?
  submittedAt DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([giverId])
  @@index([takerId])
  @@index([status])
  @@index([deadline])
}

// Reputation & Trust System
model ReputationProfile {
  id String @id @default(uuid())

  userId String @unique
  user   User   @relation("UserReputation", fields: [userId], references: [id], onDelete: Cascade)

  // Deal statistics
  totalDeals      Int     @default(0)
  successfulDeals Int     @default(0)
  successRate     Decimal @default(0) @db.Decimal(5, 2) // Percentage

  // Rating statistics  
  averageRating   Decimal @default(0) @db.Decimal(3, 2) // 1-5 scale
  ratingsReceived Int     @default(0)

  // Quest statistics
  questsCompleted  Int     @default(0)
  questsPosted     Int     @default(0)
  questSuccessRate Decimal @default(0) @db.Decimal(5, 2)

  // Contract statistics
  contractsSigned Int @default(0)
  activeContracts Int @default(0)

  // Achievements
  badges Json[] // [{id, name, earnedAt}]

  updatedAt DateTime @updatedAt

  @@index([userId])
}

model KhuralGroup {
  id            String        @id @default(uuid())
  level         KhuralLevel
  name          String
  parentGroupId String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  parentGroup   KhuralGroup?  @relation("GroupHierarchy", fields: [parentGroupId], references: [id])
  childGroups   KhuralGroup[] @relation("GroupHierarchy")
  seats         KhuralSeat[]

  @@index([level])
  @@index([parentGroupId])
}

model KhuralSeat {
  id             String      @id @default(uuid())
  index          Int
  groupId        String
  occupantUserId String?
  isLeaderSeat   Boolean     @default(false)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  group          KhuralGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  occupant       User?       @relation(fields: [occupantUserId], references: [id])

  @@unique([groupId, index])
  @@index([groupId])
  @@index([occupantUserId])
}

model Guild {
  id                  String                    @id @default(uuid())
  type                GuildType
  name                String
  description         String?
  professionId        String?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  profession          Profession?               @relation(fields: [professionId], references: [id])
  members             GuildMember[]
  tasks               Task[]
  organizationMembers User[]                    @relation("OrganizationMembers")
  arbanVerifications  ArbanMutualVerification[] @relation("ArbanVerifications")

  @@index([type])
  @@index([professionId])
}

model GuildMember {
  id             String     @id @default(uuid())
  guildId        String
  userId         String
  role           MemberRole @default(MEMBER)
  professionRank Int?
  level          Int        @default(1)
  xp             Int        @default(0)
  joinedAt       DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  guild          Guild      @relation(fields: [guildId], references: [id], onDelete: Cascade)
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([guildId, userId])
  @@index([guildId])
  @@index([userId])
}

model Profession {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  guilds      Guild[]
  tasks       Task[]

  @@index([name])
}

model Task {
  id              String      @id @default(uuid())
  title           String
  description     String
  professionId    String?
  rewardAltan     Decimal     @db.Decimal(18, 6)
  status          TaskStatus  @default(OPEN)
  assignedUserId  String?
  createdByUserId String
  postedByGuildId String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  completedAt     DateTime?
  assignedUser    User?       @relation("TaskAssignee", fields: [assignedUserId], references: [id])
  createdBy       User        @relation("TaskCreator", fields: [createdByUserId], references: [id])
  postedByGuild   Guild?      @relation(fields: [postedByGuildId], references: [id])
  profession      Profession? @relation(fields: [professionId], references: [id])

  @@index([status])
  @@index([professionId])
  @@index([assignedUserId])
  @@index([postedByGuildId])
}

model AltanLedger {
  id              String    @id @default(uuid())
  userId          String    @unique
  balance         Decimal   @default(0) @db.Decimal(18, 6)
  lastSyncedBlock BigInt?
  lastSyncedAt    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AltanTransaction {
  id          String            @id @default(uuid())
  fromUserId  String?
  toUserId    String?
  amount      Decimal           @db.Decimal(18, 6)
  type        TransactionType
  status      TransactionStatus @default(COMPLETED)
  txHash      String?
  blockNumber BigInt?
  createdAt   DateTime          @default(now())
  fromBankRef String?
  toBankRef   String?
  memo        String?
  fromUser    User?             @relation("SentTransactions", fields: [fromUserId], references: [id])
  toUser      User?             @relation("ReceivedTransactions", fields: [toUserId], references: [id])
  ubiPayments UbiPayment[]      // Link to UBI payment records

  @@index([fromUserId])
  @@index([toUserId])
  @@index([fromBankRef])
  @@index([toBankRef])
  @@index([type])
}

model UbiPayment {
  id              String           @id @default(uuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id])
  
  weekStartDate   DateTime         // Monday of the week (e.g., 2026-02-03 00:00:00)
  weekEndDate     DateTime         // Sunday of the week (e.g., 2026-02-09 23:59:59)
  amount          Int              @default(400)
  
  transactionId   String?          @unique
  transaction     AltanTransaction? @relation(fields: [transactionId], references: [id])
  
  status          UbiPaymentStatus @default(PENDING)
  failureReason   String?
  
  createdAt       DateTime         @default(now())
  processedAt     DateTime?
  
  @@unique([userId, weekStartDate]) // Prevent duplicate payments for same week
  @@index([weekStartDate])
  @@index([status])
  @@index([userId])
}

model AuditLog {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  userId       String?
  action       String
  resourceType String?
  resourceId   String?
  metadata     Json?
  ipAddress    String?
  userAgent    String?
  hash         String?
  user         User?    @relation(fields: [userId], references: [id])
}

model KhuralEvent {
  id                String               @id @default(uuid())
  date              DateTime             @default(now())
  title             String
  description       String
  type              KhuralEventType
  isVerified        Boolean              @default(false)
  relatedProposalId String?
  versions          KhuralEventVersion[]
}

model KhuralEventVersion {
  id               String        @id @default(uuid())
  eventId          String
  title            String
  description      String
  proposedByUserId String
  isApproved       Boolean       @default(false)
  approvedAt       DateTime?
  createdAt        DateTime      @default(now())
  votes            CouncilVote[]
  event            KhuralEvent   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  proposedByUser   User          @relation("HistoryProposer", fields: [proposedByUserId], references: [id])

  @@index([eventId])
}

model CouncilVote {
  id          String             @id @default(uuid())
  versionId   String
  voterUserId String
  vote        Boolean
  createdAt   DateTime           @default(now())
  version     KhuralEventVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  voterUser   User               @relation("CouncilVoter", fields: [voterUserId], references: [id])

  @@unique([versionId, voterUserId])
}

model UnlockRequest {
  id        String           @id @default(uuid())
  userId    String           @unique
  status    WalletStatus     @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  approvals UnlockApproval[]
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UnlockApproval {
  id             String        @id @default(uuid())
  requestId      String
  approverUserId String
  createdAt      DateTime      @default(now())
  approver       User          @relation(fields: [approverUserId], references: [id])
  request        UnlockRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@unique([requestId, approverUserId])
}

model CentralBankOfficer {
  id             String                 @id @default(uuid())
  walletAddress  String                 @unique
  role           CentralBankRole
  name           String?
  appointedAt    DateTime               @default(now())
  revokedAt      DateTime?
  isActive       Boolean                @default(true)
  licenseActions CentralBankLicense[]   @relation("LicenseIssuer")
  emissions      EmissionRecord[]
  policyChanges  MonetaryPolicyChange[]

  @@index([walletAddress])
  @@index([role])
}

model CentralBankLicense {
  id           String              @id @default(uuid())
  bankAddress  String              @unique
  bankCode     String              @unique
  bankName     String
  status       LicenseStatus       @default(ACTIVE)
  issuedAt     DateTime            @default(now())
  revokedAt    DateTime?
  revokeReason String?
  txHash       String?
  issuedById   String?
  issuedBy     CentralBankOfficer? @relation("LicenseIssuer", fields: [issuedById], references: [id])
  corrAccount  CorrAccount?

  @@index([bankCode])
  @@index([status])
}

model CorrAccount {
  id         String             @id @default(uuid())
  licenseId  String             @unique
  accountRef String             @unique
  balance    Decimal            @default(0) @db.Decimal(18, 6)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  license    CentralBankLicense @relation(fields: [licenseId], references: [id])
  emissions  EmissionRecord[]

  @@index([accountRef])
}

model EmissionRecord {
  id             String              @id @default(uuid())
  type           EmissionType
  amount         Decimal             @db.Decimal(18, 6)
  reason         String
  memo           String?
  corrAccountId  String?
  authorizedById String?
  txHash         String?
  blockNumber    BigInt?
  status         TransactionStatus   @default(COMPLETED)
  createdAt      DateTime            @default(now())
  authorizedBy   CentralBankOfficer? @relation(fields: [authorizedById], references: [id])
  corrAccount    CorrAccount?        @relation(fields: [corrAccountId], references: [id])

  @@index([type])
  @@index([corrAccountId])
  @@index([createdAt])
}

model MonetaryPolicy {
  id                 String   @id @default(uuid())
  officialRate       Decimal  @db.Decimal(10, 4)
  reserveRequirement Decimal  @db.Decimal(10, 4)
  dailyEmissionLimit Decimal  @db.Decimal(18, 6)
  isActive           Boolean  @default(true)
  effectiveFrom      DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([isActive])
}

model MonetaryPolicyChange {
  id             String              @id @default(uuid())
  parameter      String
  previousValue  String
  newValue       String
  reason         String?
  authorizedById String?
  txHash         String?
  effectiveAt    DateTime            @default(now())
  createdAt      DateTime            @default(now())
  authorizedBy   CentralBankOfficer? @relation(fields: [authorizedById], references: [id])

  @@index([parameter])
  @@index([effectiveAt])
}

model FamilyArban {
  id                 String             @id @default(uuid())
  arbanId            BigInt             @unique
  husbandSeatId      String // Changed from BigInt to String
  wifeSeatId         String // Changed from BigInt to String
  heirSeatId         String? // Changed from BigInt to String
  zunId              BigInt?
  khuralRepSeatId    String? // Changed from BigInt to String
  khuralRepBirthYear Int?
  isActive           Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  zun                Zun?               @relation(fields: [zunId], references: [zunId])
  children           FamilyArbanChild[]

  @@index([husbandSeatId])
  @@index([wifeSeatId])
  @@index([zunId])
  @@index([khuralRepSeatId])
}

model FamilyArbanChild {
  id          String      @id @default(uuid())
  arbanId     BigInt
  childSeatId String // Changed from BigInt to String
  addedAt     DateTime    @default(now())
  familyArban FamilyArban @relation(fields: [arbanId], references: [arbanId], onDelete: Cascade)

  @@unique([arbanId, childSeatId])
  @@index([arbanId])
  @@index([childSeatId])
}

model Zun {
  id             String        @id @default(uuid())
  zunId          BigInt        @unique
  name           String
  founderArbanId BigInt
  elderSeatId    String? // Changed from BigInt to String
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  memberArbans   FamilyArban[]

  @@index([founderArbanId])
  @@index([elderSeatId])
}

model OrganizationalArban {
  id           String                @id @default(uuid())
  arbanId      BigInt                @unique
  name         String
  orgType      OrgArbanType
  powerBranch  PowerBranchType
  parentOrgId  BigInt?
  leaderSeatId String? // Changed from BigInt to String
  isActive     Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  members      OrgArbanMember[]
  parent       OrganizationalArban?  @relation("OrgHierarchy", fields: [parentOrgId], references: [arbanId])
  departments  OrganizationalArban[] @relation("OrgHierarchy")

  // Transparency: Activity and Report tracking
  activities      ActivityEntry[]        @relation("OrgActivities")
  activityReports BranchActivityReport[] @relation("OrgReports")

  @@index([orgType])
  @@index([powerBranch])
  @@index([parentOrgId])
  @@index([leaderSeatId])
}

model OrgArbanMember {
  id       String              @id @default(uuid())
  arbanId  BigInt
  seatId   String // Changed from BigInt to String
  joinedAt DateTime            @default(now())
  org      OrganizationalArban @relation(fields: [arbanId], references: [arbanId], onDelete: Cascade)

  @@unique([arbanId, seatId])
  @@index([arbanId])
  @@index([seatId])
}

model CreditLine {
  id            String         @id @default(uuid())
  arbanId       BigInt         @unique
  creditType    CreditLineType
  creditRating  Int            @default(500)
  creditLimit   Decimal        @db.Decimal(18, 6)
  borrowed      Decimal        @default(0) @db.Decimal(18, 6)
  totalBorrowed Decimal        @default(0) @db.Decimal(18, 6)
  totalRepaid   Decimal        @default(0) @db.Decimal(18, 6)
  defaultCount  Int            @default(0)
  onTimeCount   Int            @default(0)
  isActive      Boolean        @default(true)
  openedAt      DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  loans         Loan[]

  @@index([arbanId])
  @@index([creditType])
  @@index([creditRating])
}

model Loan {
  id           String         @id @default(uuid())
  loanId       BigInt         @unique
  arbanId      BigInt
  creditType   CreditLineType
  principal    Decimal        @db.Decimal(18, 6)
  interest     Decimal        @db.Decimal(18, 6)
  dueDate      DateTime
  borrowedAt   DateTime       @default(now())
  repaidAt     DateTime?
  isActive     Boolean        @default(true)
  isDefaulted  Boolean        @default(false)
  txHashBorrow String?
  txHashRepay  String?
  creditLine   CreditLine     @relation(fields: [arbanId], references: [arbanId], onDelete: Cascade)

  @@index([arbanId])
  @@index([creditType])
  @@index([isActive])
  @@index([dueDate])
}

model TierDistribution {
  id              String        @id @default(uuid())
  seatId          String // Changed from BigInt to String
  accountId       BigInt
  tier            Int
  arbanType       TierArbanType
  arbanId         BigInt
  amount          Decimal       @db.Decimal(18, 6)
  requestedAt     DateTime      @default(now())
  approved        Boolean       @default(false)
  rejected        Boolean       @default(false)
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?
  txHash          String?

  @@index([seatId])
  @@index([tier])
  @@index([arbanType])
  @@index([arbanId])
  @@index([approved])
  @@index([rejected])
}

model TierReceived {
  id         String   @id @default(uuid())
  seatId     String // Changed from BigInt to String
  tier       Int
  receivedAt DateTime @default(now())
  amount     Decimal  @db.Decimal(18, 6)
  txHash     String?

  @@unique([seatId, tier])
  @@index([seatId])
}

enum UserRole {
  CITIZEN
  LEADER
  ADMIN
  CREATOR // Supreme admin - can manage all admins and users
  NOTARY // State Archive notary
  STATE_LAWYER // State Archive legal officer
  CB_GOVERNOR // Central Bank Governor
}

enum WalletStatus {
  LOCKED
  PENDING
  UNLOCKED
}

enum VerificationStatus {
  DRAFT
  PENDING
  VERIFIED
  REJECTED
}

enum VerificationLevel {
  UNVERIFIED // Default: new users, 100 ALTAN limit
  ARBAN_VERIFIED // Arban member with mutual verification, 1000 ALTAN shared
  ZUN_VERIFIED // Admin approved, 10,000 ALTAN limit
  FULLY_VERIFIED // Citizen status, unlimited, can own land
}

enum KhuralLevel {
  ARBAN
  ZUUN
  MYANGAN
  TUMEN
}

enum GuildType {
  CLAN
  PROFESSION
  ORGANIZATION
  GOVERNMENT
}

enum MemberRole {
  MEMBER
  OFFICER
  LEADER
}

enum TaskStatus {
  OPEN
  TAKEN
  COMPLETED
  CANCELLED
}

enum TransactionType {
  TRANSFER
  MINT
  BURN
  REWARD
  FEE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum UbiPaymentStatus {
  PENDING    // Scheduled but not yet processed
  COMPLETED  // Successfully transferred
  FAILED     // Transfer failed
  SKIPPED    // User not eligible
}

enum KhuralEventType {
  SESSION_START
  DECREE_SIGNED
  APPOINTMENT
  AMENDMENT
  EMERGENCY
}

enum CentralBankRole {
  GOVERNOR
  BOARD_MEMBER
}

enum LicenseStatus {
  ACTIVE
  SUSPENDED
  REVOKED
}

enum EmissionType {
  MINT
  BURN
}

enum OrgArbanType {
  NONE
  EXECUTIVE
  JUDICIAL
  BANKING
  PRIVATE_COMPANY
  STATE_COMPANY
  GUILD
  SCIENTIFIC_COUNCIL
  EKHE_KHURAL
}

enum PowerBranchType {
  NONE
  LEGISLATIVE
  EXECUTIVE
  JUDICIAL
  BANKING
}

enum CreditLineType {
  NONE
  FAMILY
  ORG
}

enum TierArbanType {
  NONE
  FAMILY
  ORG
}

model DigitalSeal {
  id              String    @id @default(uuid())
  contractAddress String    @unique
  signer1SeatId   String
  signer2SeatId   String
  documentHash    String?
  title           String?
  description     String?
  approvalCount   Int       @default(0)
  signer1Approved Boolean   @default(false)
  signer2Approved Boolean   @default(false)
  executed        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  executedAt      DateTime?
  updatedAt       DateTime  @updatedAt

  @@index([signer1SeatId])
  @@index([signer2SeatId])
  @@index([executed])
}

model TempleRecord {
  id                 String     @id @default(uuid())
  contractAddress    String // Temple contract address
  documentHash       String     @unique
  recordType         RecordType
  submitterSeatId    String
  scientificVerified Boolean    @default(false)
  ethicalVerified    Boolean    @default(false)
  scientificVerifier String?
  ethicalVerifier    String?
  metadata           String? // IPFS CID or description
  createdAt          DateTime   @default(now())
  verifiedAt         DateTime?

  @@index([submitterSeatId])
  @@index([recordType])
}

model ScientistCouncilMember {
  id                 String    @id @default(uuid())
  seatId             String    @unique
  degreeHash         String
  nominatedByArbanId String
  field              String // e.g. "Physics", "Biology"
  approvals          Int       @default(0)
  approved           Boolean   @default(false)
  walletAddress      String
  createdAt          DateTime  @default(now())
  approvedAt         DateTime?

  @@index([seatId])
  @@index([approved])
}

model WisdomCouncilMember {
  id                 String    @id @default(uuid())
  seatId             String    @unique
  nominatedByArbanId String
  virtues            String // e.g. "kind, honest, compassionate, wise"
  approvals          Int       @default(0)
  approved           Boolean   @default(false)
  walletAddress      String
  joinedAt           DateTime  @default(now())
  approvedAt         DateTime?

  @@index([seatId])
  @@index([approved])
}

enum RecordType {
  LIBRARY
  ARCHIVE
  CADASTRE
}

model Patent {
  id              String       @id @default(uuid())
  patentId        Int          @unique
  submitterSeatId String
  patentHash      String
  title           String
  field           String
  status          PatentStatus @default(PENDING)
  submittedAt     DateTime     @default(now())
  reviewedAt      DateTime?
  reviewer        String?
  reviewNotes     String?

  @@index([submitterSeatId])
  @@index([status])
}

model Discovery {
  id              String   @id @default(uuid())
  discoveryId     Int      @unique
  scientistSeatId String
  discoveryHash   String
  title           String
  description     String
  peerReviews     Int      @default(0)
  archived        Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([scientistSeatId])
  @@index([archived])
}

model ResearchGrant {
  id              String      @id @default(uuid())
  grantId         Int         @unique
  scientistSeatId String
  projectTitle    String
  description     String
  requestedAmount BigInt
  approvedAmount  BigInt      @default(0)
  status          GrantStatus @default(REQUESTED)
  requestedAt     DateTime    @default(now())
  approvedAt      DateTime?
  disbursedAt     DateTime?

  @@index([scientistSeatId])
  @@index([status])
}

// Bank Hierarchy Employee Model
model BankEmployee {
  id            String       @id @default(uuid())
  seatId        String       @unique
  wallet        String       @unique
  employeeId    BigInt       @unique // On-chain employee ID
  bankArbanId   BigInt // Arban (10) this employee belongs to
  bankZunId     BigInt? // Zun (100) parent
  bankMyanganId BigInt? // Myangan (1000) parent
  bankTumenId   BigInt? // Tumen (10000) parent
  performance   Int          @default(75)
  position      BankPosition @default(EMPLOYEE)
  isActive      Boolean      @default(true)
  joinedAt      DateTime     @default(now())
  lastActiveAt  DateTime     @default(now())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([seatId])
  @@index([wallet])
  @@index([bankArbanId])
}

enum BankPosition {
  EMPLOYEE
  TELLER
  OFFICER
  BANKER
  CHAIRMAN
}

model CouncilOfJusticeMember {
  id                 String    @id @default(uuid())
  memberId           Int       @unique
  seatId             String    @unique
  legalEducationHash String
  nominatedByArbanId String
  specialization     String
  approvals          Int       @default(0)
  approved           Boolean   @default(false)
  walletAddress      String
  casesHandled       Int       @default(0)
  createdAt          DateTime  @default(now())
  approvedAt         DateTime?

  @@index([seatId])
  @@index([approved])
}

model JudicialCase {
  id              String     @id @default(uuid())
  caseId          Int        @unique
  plaintiffSeatId String
  defendantSeatId String
  caseHash        String
  description     String
  rulingType      RulingType
  status          CaseStatus @default(PENDING)
  assignedJudge   String?
  rulingHash      String?
  ruling          String?
  filedAt         DateTime   @default(now())
  ruledAt         DateTime?

  @@index([plaintiffSeatId])
  @@index([defendantSeatId])
  @@index([status])
}

model LegalPrecedent {
  id             String   @id @default(uuid())
  precedentId    Int      @unique
  sourceCaseId   Int
  precedentHash  String
  summary        String
  legalPrinciple String
  judge          String
  archived       Boolean  @default(false)
  createdAt      DateTime @default(now())

  @@index([sourceCaseId])
}

enum PatentStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum GrantStatus {
  REQUESTED
  APPROVED
  DISBURSED
  COMPLETED
}

enum CaseStatus {
  PENDING
  ASSIGNED
  UNDER_REVIEW
  RULED
  APPEALED
  CLOSED
}

enum RulingType {
  CIVIL
  CRIMINAL
  ADMINISTRATIVE
}

// ==================== MPC WALLET SYSTEM ====================
// Multi-Party Computation wallet for Altan Native Wallet

model MPCWallet {
  id     String @id @default(uuid())
  userId String @unique

  // MPC Address
  address String @unique // Public wallet address
  chainId Int    @default(31337)

  // Key Share Metadata (NOT actual keys!)
  deviceShareId  String? // Reference to device share in browser
  serverShareEnc String? // Encrypted server share (AES-256-GCM)
  recoveryMethod RecoveryMethod @default(SOCIAL)

  // Status
  status     MPCWalletStatus @default(PENDING_SETUP)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  lastUsedAt DateTime?

  // Relations
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  keyShares    KeyShare[]
  guardians    RecoveryGuardian[]
  smartAccount SmartAccount?

  @@index([address])
  @@index([status])
}

model KeyShare {
  id       String @id @default(uuid())
  walletId String

  // Share metadata (NOT the actual share!)
  shareType  ShareType // DEVICE, SERVER, RECOVERY
  shareIndex Int // 0, 1, or 2
  publicKey  String // Public component only

  // Device info (for device shares)
  deviceId   String?
  deviceName String?
  userAgent  String?
  lastUsedAt DateTime?

  // Status
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  revokedAt    DateTime?
  revokeReason String?

  wallet MPCWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([walletId, shareType, shareIndex])
  @@index([walletId])
  @@index([deviceId])
}

model RecoveryGuardian {
  id       String @id @default(uuid())
  walletId String

  // Guardian info
  guardianType   GuardianType // FRIEND, FAMILY, EMAIL, PHONE
  guardianUserId String? // If another Altan user
  guardianRef    String // Email, phone, or user ID
  guardianName   String?

  // Status
  isConfirmed Boolean   @default(false)
  confirmedAt DateTime?

  // Recovery state
  recoveryApproved Boolean   @default(false)
  approvedAt       DateTime?

  wallet MPCWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([walletId, guardianRef])
  @@index([walletId])
  @@index([guardianUserId])
}

model RecoverySession {
  id       String @id @default(uuid())
  walletId String

  // Session state
  status RecoverySessionStatus @default(PENDING)
  method RecoveryMethod

  // Verification
  verificationCode   String?
  verificationSentTo String?
  codeExpiresAt      DateTime?

  // Approval tracking (for SOCIAL recovery)
  requiredApprovals Int @default(2)
  currentApprovals  Int @default(0)

  // Timestamps
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  completedAt DateTime?

  @@index([walletId])
  @@index([status])
}

// ==================== ACCOUNT ABSTRACTION (ERC-4337) ====================

model SmartAccount {
  id       String @id @default(uuid())
  walletId String @unique

  // ERC-4337 Smart Account
  accountAddress String @unique // Smart wallet address (counterfactual)
  factoryAddress String // Factory that deploys it

  // State
  nonce        BigInt    @default(0)
  isDeployed   Boolean   @default(false)
  deployedAt   DateTime?
  deployTxHash String?

  // Gas sponsorship tracking
  totalGasSponsored BigInt   @default(0)
  dailyGasUsed      BigInt   @default(0)
  lastGasResetAt    DateTime @default(now())

  createdAt DateTime @default(now())

  wallet  MPCWallet       @relation(fields: [walletId], references: [id])
  userOps UserOperation[]

  @@index([accountAddress])
}

model UserOperation {
  id        String @id @default(uuid())
  accountId String

  // ERC-4337 UserOp data
  userOpHash String  @unique
  sender     String
  nonce      BigInt
  initCode   String? @db.Text
  callData   String  @db.Text

  // Gas parameters
  callGasLimit         BigInt
  verificationGasLimit BigInt
  preVerificationGas   BigInt
  maxFeePerGas         BigInt
  maxPriorityFeePerGas BigInt

  // Paymaster data
  paymasterAndData String? @db.Text

  // Signature
  signature String @db.Text

  // Status tracking
  status      UserOpStatus @default(PENDING)
  txHash      String?
  blockNumber BigInt?
  gasUsed     BigInt?

  // Sponsorship
  isSponsored     Boolean @default(true)
  sponsorId       String? // Paymaster ID
  sponsoredAmount BigInt?

  // Error handling
  errorMessage String?
  revertReason String?

  createdAt   DateTime  @default(now())
  submittedAt DateTime?
  executedAt  DateTime?

  account SmartAccount @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([status])
  @@index([userOpHash])
  @@index([sender])
}

// ==================== MPC ENUMS ====================

enum MPCWalletStatus {
  PENDING_SETUP // Wallet created, MPC ceremony not complete
  ACTIVE // Fully functional
  RECOVERY_MODE // User lost access, recovery in progress
  FROZEN // Admin frozen
  MIGRATING // Migrating from old wallet
}

enum ShareType {
  DEVICE // Stored in browser/mobile (IndexedDB)
  SERVER // Stored on backend (encrypted)
  RECOVERY // Stored with guardians or cloud backup
}

enum RecoveryMethod {
  SOCIAL // Friends/family approve recovery
  EMAIL // Email verification
  PHONE // SMS verification
  HARDWARE // Hardware key backup
  ARBAN // Arban-based recovery (spouse + rep)
  NONE // No recovery (dangerous)
}

enum GuardianType {
  SPOUSE // Spouse from FamilyArban
  FAMILY // Other family member
  KHURAL_REP // Khural representative
  FRIEND // Another Altan user
  EMAIL // Email recovery
  PHONE // Phone recovery
}

enum RecoverySessionStatus {
  PENDING // Session created, waiting for verification
  VERIFYING // Code sent, waiting for input
  APPROVING // Waiting for guardian approvals
  APPROVED // Ready to restore
  COMPLETED // Recovery complete
  EXPIRED // Session timed out
  CANCELLED // User cancelled
  FAILED // Recovery failed
}

enum UserOpStatus {
  PENDING // Waiting to be signed
  SIGNED // Signed, waiting for bundler
  SUBMITTED // Sent to bundler
  MEMPOOL // In bundler mempool
  INCLUDED // Included in block
  CONFIRMED // Confirmed (N blocks)
  FAILED // Execution failed
  REVERTED // Transaction reverted
  DROPPED // Dropped from mempool
}

// ============================================================================
// LEGISLATIVE BRANCH (Khural) - Phase 3 Backend Integration
// ============================================================================

enum ProposalType {
  ARBAN_BUDGET
  ARBAN_LEADER
  ARBAN_PROJECT
  ZUN_POLICY
  ZUN_ELDER
  ZUN_BUDGET
  MYANGAN_LAW
  MYANGAN_LEADER
  TUMEN_NATIONAL
  TUMEN_CHAIRMAN
  CONSTITUTIONAL
}

enum ProposalStatus {
  ACTIVE
  PASSED
  REJECTED
  EXECUTED
  CANCELLED
}

model Proposal {
  id           String       @id @default(uuid())
  proposalId   Int          @unique // On-chain proposal ID
  proposalType ProposalType
  khuralLevel  KhuralLevel
  khuralId     Int // Specific Arban/Zun/Myangan/Tumen ID

  title         String
  description   String
  executionData String? // Hex encoded calldata

  proposer       String // Wallet address
  proposerSeatId String? // Link to User

  status       ProposalStatus @default(ACTIVE)
  votingPeriod Int // Duration in seconds
  startTime    DateTime       @default(now())
  endTime      DateTime

  votesFor       Int @default(0)
  votesAgainst   Int @default(0)
  quorumRequired Int // Number of votes needed

  finalized   Boolean   @default(false)
  finalizedAt DateTime?
  executed    Boolean   @default(false)
  executedAt  DateTime?

  txHash      String? // Transaction hash
  blockNumber Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  votes        Vote[]
  proposerUser User?  @relation("ProposalCreator", fields: [proposerSeatId], references: [seatId])

  @@index([proposalId])
  @@index([khuralLevel, khuralId])
  @@index([status])
  @@index([proposer])
}

model Vote {
  id         String   @id @default(uuid())
  proposalId String
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  voter       String // Wallet address
  voterSeatId String? // Link to User
  support     Boolean // true = for, false = against
  reason      String?

  khuralLevel KhuralLevel
  votingPower Int         @default(1) // Usually 1, but can be weighted

  txHash      String?
  blockNumber Int?

  createdAt DateTime @default(now())

  voterUser User? @relation("VoteCaster", fields: [voterSeatId], references: [seatId])

  @@unique([proposalId, voter])
  @@index([voter])
  @@index([proposalId])
}

model KhuralDelegate {
  id String @id @default(uuid())

  walletAddress String
  seatId        String? // Link to User

  khuralLevel KhuralLevel
  khuralId    Int // Specific Arban/Zun/Myangan/Tumen ID

  // Source information
  sourceLevel KhuralLevel? // Where they were elected from
  sourceId    Int? // Source Arban/Zun/Myangan ID

  role String // REPRESENTATIVE, DELEGATE, ELDER, LEADER, CHAIRMAN

  electedAt DateTime  @default(now())
  termEnds  DateTime?
  active    Boolean   @default(true)

  // Stats
  proposalsCreated Int @default(0)
  votescast        Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  delegateUser User? @relation("KhuralDelegate", fields: [seatId], references: [seatId])

  @@unique([walletAddress, khuralLevel, khuralId])
  @@index([seatId])
  @@index([khuralLevel, khuralId])
  @@index([active])
}

model VotingStatistics {
  id String @id @default(uuid())

  khuralLevel KhuralLevel
  period      String // e.g., "2026-01", "2026-Q1"

  totalProposals    Int @default(0)
  passedProposals   Int @default(0)
  rejectedProposals Int @default(0)
  totalVotes        Int @default(0)

  participationRate Float? // Percentage
  averageQuorum     Float?

  generatedAt DateTime @default(now())

  @@unique([khuralLevel, period])
  @@index([khuralLevel])
}

// ============== MARKETPLACE ==============

model MarketplaceListing {
  id String @id @default(uuid())

  sellerId   String
  categoryId Int

  listingType MarketplaceListingType
  status      MarketplaceListingStatus @default(ACTIVE)

  title       String
  description String
  images      String[] // Array of image URLs (IPFS or uploaded)

  price String // ALTAN amount as string
  stock Int    @default(0) // 0 = unlimited for services
  sold  Int    @default(0)

  // Ratings
  totalRating Int @default(0)
  reviewCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases MarketplacePurchase[]

  @@index([sellerId])
  @@index([categoryId])
  @@index([status])
  @@index([listingType])
}

model MarketplacePurchase {
  id String @id @default(uuid())

  listingId String
  buyerId   String

  quantity   Int
  totalPrice String // ALTAN amount

  status          MarketplacePurchaseStatus @default(PENDING)
  shippingAddress String?
  trackingInfo    String?
  txHash          String? // Blockchain transaction hash
  escrowId        String? // EscrowBank ID

  rating Int? // 1-5 stars
  review String?

  createdAt   DateTime  @default(now())
  paidAt      DateTime?
  shippedAt   DateTime?
  deliveredAt DateTime?
  completedAt DateTime?

  listing MarketplaceListing @relation(fields: [listingId], references: [id])

  @@index([listingId])
  @@index([buyerId])
  @@index([status])
}

model Job {
  id String @id @default(uuid())

  employerId String
  categoryId Int

  title        String
  description  String
  requirements String?

  salary   String // ALTAN amount
  duration String? // e.g., "3 months", "ongoing"
  location String?
  remote   Boolean @default(false)

  status JobPostingStatus @default(OPEN)

  deadline  DateTime? // Application deadline
  startDate DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  applications JobApplication[]

  @@index([employerId])
  @@index([categoryId])
  @@index([status])
}

model JobApplication {
  id String @id @default(uuid())

  jobId       String
  applicantId String

  coverLetter    String
  resumeUrl      String?
  expectedSalary String? // If negotiable

  status JobApplicationStatus @default(PENDING)

  appliedAt   DateTime  @default(now())
  respondedAt DateTime?

  employerNotes String?

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, applicantId]) // One application per job per applicant
  @@index([jobId])
  @@index([applicantId])
  @@index([status])
}

// ============== ENUMS ==============

enum MarketplaceListingType {
  PHYSICAL_GOOD
  DIGITAL_GOOD
  SERVICE
  WORK
}

enum MarketplaceListingStatus {
  DRAFT
  ACTIVE
  PAUSED
  SOLD_OUT
  ARCHIVED
}

enum MarketplacePurchaseStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  DISPUTED
  REFUNDED
}

enum JobPostingStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  CLOSED
}

enum JobApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

// Timeline Event Types
enum EventType {
  // Identity & Verification
  ACCOUNT_CREATED
  IDENTITY_VERIFIED
  CITIZENSHIP_GRANTED

  // Contracts & Agreements
  CONTRACT_SIGNED
  CONTRACT_COMPLETED
  CONTRACT_CANCELLED

  // Tasks & Work
  TASK_ASSIGNED
  TASK_COMPLETED
  TASK_REVIEWED

  // Banking & Finance
  LOAN_REQUESTED
  LOAN_APPROVED
  LOAN_REPAID
  PAYMENT_MADE

  // Governance
  VOTE_CAST
  PROPOSAL_SUBMITTED
  LAW_ENACTED

  // Education & Skills
  COURSE_COMPLETED
  CERTIFICATION_EARNED

  // Justice
  CASE_FILED
  JUDGMENT_RENDERED

  // Quests (NEW)
  QUEST_CREATED
  QUEST_ACCEPTED
  QUEST_SUBMITTED
  QUEST_COMPLETED
  QUEST_REJECTED

  // Documents (NEW)
  DOCUMENT_CREATED
  DOCUMENT_SIGNED
  DOCUMENT_FINALIZED

  // Custom
  CUSTOM_EVENT
}

// Event Scope (hierarchical levels)
enum EventScope {
  INDIVIDUAL
  FAMILY
  CLAN
  ARBAN
  HORDE
  NATION
  CONFEDERATION
}

// Guild & Organization Rating System
enum OrganizationType {
  GUILD // Craftsmen, merchants
  COMMITTEE // Temporary working groups
  SERVICE // Public services
  ARBAN // 10-person unit
  HUNDRED // 100-person unit
  THOUSAND // 1000-person unit
  REPUBLIC // Republic-level
  CONFEDERATION // Confederation-level
}

enum BranchType {
  LEGISLATIVE
  EXECUTIVE
  JUSTICE
  BANKING
  CIVIL_SERVICE
}

enum RatingCategory {
  TRUST
  QUALITY
  FINANCIAL
  LEADERSHIP
  INNOVATION
}

// ============== CHANCELLERY & ARCHIVE SYSTEM ==============

enum DocumentType {
  EMPLOYMENT_CONTRACT
  SERVICE_CONTRACT
  PURCHASE_AGREEMENT
  LEASE_AGREEMENT
  LOAN_AGREEMENT
  PARTNERSHIP_AGREEMENT
  QUEST_ASSIGNMENT
  WORK_ACCEPTANCE
  COMPLETION_REPORT
  PETITION
  CERTIFICATE
  ORDER
  CUSTOM
}

// NOTE: Old DocumentStatus enum removed - see State Archive system DocumentStatus (line ~615)

enum SignatureRole {
  CREATOR
  RECIPIENT
  WITNESS
  AUTHORITY
}

enum QuestStatus {
  OPEN
  ASSIGNED
  ACCEPTED
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  COMPLETED
  REJECTED
  CANCELLED
  EXPIRED
}

// ============== GUILD & ORGANIZATION RATING SYSTEM ==============

model Organization {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic info
  name        String
  type        OrganizationType
  branch      BranchType?
  description String?

  // Hierarchical structure
  parentId String?
  parent   Organization?  @relation("SubOrganizations", fields: [parentId], references: [id])
  children Organization[] @relation("SubOrganizations")
  level    Int // 1=Arban, 10=Hundred, 100=Thousand, etc.

  // Geographic/ethnic scope
  republicId String?
  republic   String? // "Russian", "Buryad-Mongol", etc.

  // Guild-specific education requirements
  requiresEducation Boolean @default(false)
  fieldOfStudy      String? // "Engineering", "Medicine", etc.

  // Leadership
  leaderId String
  leader   User   @relation("OrganizationLeader", fields: [leaderId], references: [id])

  // Members
  members    OrganizationMember[]
  minMembers Int                  @default(10)
  maxMembers Int                  @default(10)

  // Financial
  treasury    Decimal @default(0)
  totalEarned Decimal @default(0)

  // Ratings (1-10 scale)
  trustScore     Decimal @default(5.0)
  qualityScore   Decimal @default(5.0)
  financialScore Decimal @default(5.0)
  overallRating  Decimal @default(5.0) // Weighted average

  // Statistics
  contractsCompleted Int     @default(0)
  contractsActive    Int     @default(0)
  totalRevenue       Decimal @default(0)

  // Rankings
  currentRank  Int?
  previousRank Int?

  // Relations
  ratings      OrganizationRating[]
  achievements OrganizationAchievement[]
  networkNodes ArbanNetwork[]
  invitations  GuildInvitation[]         @relation("GuildInvitations")
  elections    Election[]                @relation("Elections")

  @@index([type, overallRating])
  @@index([republicId])
  @@index([currentRank])
}

model OrganizationMember {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  userId String
  user   User   @relation("OrganizationMemberships", fields: [userId], references: [id])

  // WHO INVITED THIS MEMBER (for trust chain)
  invitedBy String?
  inviter   User?   @relation("MemberInvitations", fields: [invitedBy], references: [id])

  role     MemberRole @default(MEMBER)
  joinedAt DateTime   @default(now())
  leftAt   DateTime?

  // Performance
  contributionScore Decimal @default(0)

  @@unique([organizationId, userId])
  @@index([userId])
}

model OrganizationRating {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  raterId String
  rater   User   @relation("OrganizationRatingsGiven", fields: [raterId], references: [id])

  category RatingCategory
  score    Int // 1-10
  comment  String?

  // Context
  contractId String? // If rating based on contract

  @@index([organizationId, category])
  @@index([raterId])
}

model OrganizationAchievement {
  id        String   @id @default(uuid())
  awardedAt DateTime @default(now())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  title       String
  description String
  category    String // "Top 10", "Top 100", "Innovation", etc.
  rank        Int?

  // Rewards
  rewardAltan Decimal?
  badge       String?

  @@index([organizationId])
}

model ArbanNetwork {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  arbanId String       @unique
  arban   Organization @relation(fields: [arbanId], references: [id])

  // Network position (for interactive map)
  positionX Float
  positionY Float
  layer     Int // Hierarchical layer

  // Connections
  connectedTo String[] // Array of connected Arban IDs

  // Visual metadata
  clusterColor String? // Gold for center, white for outer
  importance   Int     @default(0)

  @@index([layer])
}

// Guild & Organization Extension Enums
enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum ElectionStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum EducationType {
  DIPLOMA
  CERTIFICATE
  RECOMMENDATION
}

// ============== EDUCATION VERIFICATION ==============

model EducationVerification {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation("EducationVerifications", fields: [userId], references: [id])

  // Document details
  type           EducationType
  institution    String // University/school name
  fieldOfStudy   String // "Engineering", "Medicine", etc.
  graduationYear Int?

  // Verification
  documentHash String? // Hash of uploaded document
  documentUrl  String? // IPFS or storage URL

  // Recommendation (if type = RECOMMENDATION)
  recommenderId String?
  recommender   User?   @relation("EducationRecommendations", fields: [recommenderId], references: [id])

  // Status
  isVerified Boolean   @default(false)
  verifiedBy String? // Admin who verified
  verifiedAt DateTime?

  // Guilds this qualification allows
  validForGuilds String[] // Array of guild IDs or categories

  @@index([userId])
  @@index([isVerified])
  @@index([fieldOfStudy])
}

// ============== GUILD INVITATIONS ==============

model GuildInvitation {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  guildId String
  guild   Organization @relation("GuildInvitations", fields: [guildId], references: [id])

  inviterId String
  inviter   User   @relation("InvitationsSent", fields: [inviterId], references: [id])

  inviteeId String
  invitee   User   @relation("InvitationsReceived", fields: [inviteeId], references: [id])

  status InvitationStatus @default(PENDING)

  // Responsibility chain
  message String? // Why inviting this person

  acceptedAt DateTime?
  rejectedAt DateTime?
  expiredAt  DateTime?

  @@unique([guildId, inviteeId])
  @@index([inviterId])
  @@index([inviteeId])
  @@index([guildId, status])
}

// ============== ELECTION SYSTEM ==============

model Election {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  organizationId String
  organization   Organization @relation("Elections", fields: [organizationId], references: [id])

  // Election details
  startDate DateTime
  endDate   DateTime
  status    ElectionStatus @default(UPCOMING)

  // Candidates (leaders of child organizations)
  candidates ElectionCandidate[]

  // Winner
  winnerId    String?
  winner      User?   @relation("ElectionsWon", fields: [winnerId], references: [id])
  winnerVotes Int?

  totalVotes  Int      @default(0)
  turnoutRate Decimal? // Percentage

  @@index([organizationId])
  @@index([status])
  @@index([startDate])
}

model ElectionCandidate {
  id String @id @default(uuid())

  electionId String
  election   Election @relation(fields: [electionId], references: [id])

  candidateId String
  candidate   User   @relation("ElectionCandidacies", fields: [candidateId], references: [id])

  // Campaign
  platform String? // Candidate's platform/promises
  votes    Int     @default(0)

  createdAt DateTime @default(now())

  @@unique([electionId, candidateId])
  @@index([electionId])
  @@index([candidateId])
}

// ============== UPDATE ORGANIZATION MEMBER ==============
// Add invitedBy field tracking (will update in separate step)

// ============== TRANSPARENCY & ACCOUNTABILITY SYSTEM ==============
// GOST-standardized activity logging with minute-level precision

// Universal Activity Entry - logged at minute precision for all 4 branches
model ActivityEntry {
  id String @id @default(uuid())

  // GOST Standard Fields (Стандарт ГОСТ от Канцелярии)
  actionName        String // Название действия
  actionDescription String @db.Text // Описание
  actionParameters  Json // Параметры (flexible structure)

  // Timing (down to the minute)
  performedAt     DateTime @default(now()) @db.Timestamptz(0) // Minute precision
  durationMinutes Int? // How long action took

  // Actor
  performedByUserId String
  performedBy       User   @relation("UserActivities", fields: [performedByUserId], references: [id], onDelete: Cascade)

  // Organizational Context
  orgArbanId     String?
  orgArban       OrganizationalArban? @relation("OrgActivities", fields: [orgArbanId], references: [id], onDelete: SetNull)
  hierarchyLevel HierarchyLevel? // 1, 10, 100, 1000, 10000, REPUBLIC, CONFEDERATION

  // Power Branch
  powerBranch PowerBranchType // LEGISLATIVE, EXECUTIVE, JUDICIAL, BANKING

  // Template reference
  templateId String?
  template   ActivityTemplate? @relation("TemplateActivities", fields: [templateId], references: [id], onDelete: SetNull)

  // Blockchain integration
  txHash          String?
  blockNumber     BigInt?
  contractAddress String?

  // Aggregation
  reportId String?
  report   BranchActivityReport? @relation("ReportActivities", fields: [reportId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([performedAt])
  @@index([powerBranch])
  @@index([hierarchyLevel])
  @@index([orgArbanId])
  @@index([performedByUserId])
  @@index([templateId])
  @@index([reportId])
}

// GOST-standardized templates (from Chancellery)
model ActivityTemplate {
  id          String          @id @default(uuid())
  code        String          @unique // e.g., "GOST-ORG-001", "GOST-LEG-002"
  name        String // Template name
  description String          @db.Text
  powerBranch PowerBranchType

  // Template parameters schema (JSON Schema)
  parametersSchema Json // Defines required/optional fields

  // Template content
  actionNameTemplate  String // Template for action name
  descriptionTemplate String @db.Text // Template for description

  // Hierarchy applicability
  applicableLevels HierarchyLevel[] // Which levels can use this template

  // Versioning
  version  String  @default("1.0")
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activities ActivityEntry[] @relation("TemplateActivities")

  @@index([code])
  @@index([powerBranch])
  @@index([isActive])
}

// Aggregated reports (hourly, daily, weekly summaries)
model BranchActivityReport {
  id             String          @id @default(uuid())
  powerBranch    PowerBranchType
  hierarchyLevel HierarchyLevel?

  // Time period
  periodStart DateTime         @db.Timestamptz(0)
  periodEnd   DateTime         @db.Timestamptz(0)
  periodType  ReportPeriodType // REALTIME, HOURLY, DAILY, WEEKLY, MONTHLY

  // Summary
  title           String
  summary         String @db.Text // Auto-generated summary
  totalActivities Int    @default(0)

  // Organizational context
  orgArbanId String?
  orgArban   OrganizationalArban? @relation("OrgReports", fields: [orgArbanId], references: [id], onDelete: SetNull)

  // Linked activities
  activities ActivityEntry[] @relation("ReportActivities")

  // Metadata
  metadata Json?
  isPublic Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([powerBranch])
  @@index([hierarchyLevel])
  @@index([periodStart])
  @@index([periodType])
  @@index([orgArbanId])
  @@index([isPublic])
}

// Hierarchy levels in organizational system
enum HierarchyLevel {
  LEVEL_1 // Individual/Family
  LEVEL_10 // Arban
  LEVEL_100 // Zun
  LEVEL_1000 // Myangan
  LEVEL_10000 // Tumen
  REPUBLIC // Republican Khural
  CONFEDERATION // Confederative Khural
}

// Report period types for aggregation
enum ReportPeriodType {
  REALTIME // Live activity feed
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
}

// ============== MIGRATION SERVICE (Passport Office) ==============

enum PassportType {
  STANDARD
  DIPLOMATIC
  SERVICE
}

enum PassportApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  ISSUED
}

enum PassportDocumentType {
  PHOTO
  SIGNATURE
  BIRTH_CERTIFICATE
  OTHER
}

model PassportApplication {
  id String @id @default(uuid())

  applicantId String
  applicant   User   @relation("PassportApplicant", fields: [applicantId], references: [id])

  // Personal data
  fullName     String
  dateOfBirth  DateTime
  placeOfBirth String
  nationality  String
  sex          String
  height       Int?
  eyeColor     String?

  // Parents
  fatherName String?
  motherName String?

  // Address
  address    String
  city       String
  region     String
  postalCode String?

  // Passport
  passportType           PassportType @default(STANDARD)
  previousPassportNumber String?

  // Status
  status     PassportApplicationStatus @default(DRAFT)
  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?

  // Issued passport
  issuedPassportNumber String? @unique
  issuedAt             DateTime?
  expiresAt            DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents PassportDocument[]

  @@index([applicantId])
  @@index([status])
  @@index([issuedPassportNumber])
}

model PassportDocument {
  id String @id @default(uuid())

  applicationId String
  application   PassportApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  type        PassportDocumentType
  filename    String
  mimeType    String
  size        Int
  storagePath String
  isEncrypted Boolean @default(false)

  uploadedAt DateTime @default(now())

  @@index([applicationId])
}

// ============== ZAGS (Civil Registry Office) ==============

enum CivilStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum MarriageAppStatus {
  PENDING_CONSENT
  PENDING_REVIEW
  APPROVED
  REGISTERED
  REJECTED
  CANCELLED
}

enum ConsentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DivorceStatus {
  FILED
  UNDER_REVIEW
  FINALIZED
  REJECTED
}

enum CeremonyType {
  CIVIL
  RELIGIOUS
  TRADITIONAL
}

enum PropertyRegime {
  SEPARATE
  JOINT
  CUSTOM
}

model Marriage {
  id                String @id @default(uuid())
  certificateNumber String @unique @default(uuid())

  // Spouses
  spouse1Id        String
  spouse1          User   @relation("Spouse1Marriages", fields: [spouse1Id], references: [id])
  spouse2Id        String
  spouse2          User   @relation("Spouse2Marriages", fields: [spouse2Id], references: [id])
  spouse1FullName  String
  spouse2FullName  String
  spouse1DateOfBirth DateTime
  spouse2DateOfBirth DateTime

  // Marriage details
  marriageDate     DateTime
  ceremonyLocation String?
  ceremonyType     CeremonyType?

  // Witnesses
  witness1Name String?
  witness2Name String?
  witness1Id   String?
  witness2Id   String?

  // Property regime
  propertyRegime    PropertyRegime?
  propertyAgreement String?

  // Consent tracking
  spouse1ConsentGranted Boolean @default(false)
  spouse2ConsentGranted Boolean @default(false)
  spouse1ConsentedAt    DateTime?
  spouse2ConsentedAt    DateTime?

  // Status
  status MarriageAppStatus @default(PENDING_CONSENT)

  // Registration
  registeredBy String?
  registeredAt DateTime?

  isPublic Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  consents MarriageConsent[]
  divorces ZagsDivorce[]

  @@index([spouse1Id])
  @@index([spouse2Id])
  @@index([status])
  @@index([certificateNumber])
}

model MarriageConsent {
  id String @id @default(uuid())

  marriageId String
  marriage   Marriage @relation(fields: [marriageId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("MarriageConsents", fields: [userId], references: [id])

  status      ConsentStatus @default(PENDING)
  consentedAt DateTime?
  signature   String?

  createdAt DateTime @default(now())

  @@unique([marriageId, userId])
  @@index([userId])
}

model ZagsDivorce {
  id String @id @default(uuid())

  marriageId               String
  marriage                 Marriage @relation(fields: [marriageId], references: [id])
  divorceCertificateNumber String   @unique @default(uuid())

  initiatedById String
  initiatedBy   User   @relation("DivorceInitiator", fields: [initiatedById], references: [id])

  reason           String
  status           DivorceStatus @default(FILED)
  propertyDivision String?

  finalizedDate DateTime?
  finalizedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([marriageId])
  @@index([initiatedById])
  @@index([status])
}

// ============== LAND REGISTRY ==============

enum LandType {
  AGRICULTURAL
  RESIDENTIAL
  COMMERCIAL
  INDUSTRIAL
  FOREST
  OTHER_LAND
}

enum LandPropertyType {
  RESIDENTIAL_PROP
  COMMERCIAL_PROP
  INDUSTRIAL_PROP
  AGRICULTURAL_PROP
  MIXED
  OTHER_PROP
}

enum LandOwnershipType {
  FULL
  SHARED
}

enum LeaseType {
  RESIDENTIAL_LEASE
  COMMERCIAL_LEASE
  AGRICULTURAL_LEASE
  INDUSTRIAL_LEASE
}

enum LandTransactionType {
  SALE
  TRANSFER
  INHERITANCE
  GIFT
  MORTGAGE
  LEASE_TX
  COURT_ORDER
  EXPROPRIATION
  OTHER_TX
}

enum LandTransactionStatus {
  INITIATED
  PAYMENT_PENDING
  PAYMENT_CONFIRMED
  COMPLETED
  CANCELLED
}

model LandPlot {
  id              String @id @default(uuid())
  cadastralNumber String @unique

  // Location
  region   String
  district String
  locality String?
  address  String?

  // Geographic data
  latitude   Float
  longitude  Float
  boundaries Json?  // GeoJSON polygon
  area       Float  // square meters

  // Land details
  landType    LandType
  soilQuality String?
  irrigated   Boolean @default(false)

  // Registration
  registeredById String
  registeredBy   User     @relation("LandRegistrar", fields: [registeredById], references: [id])
  registeredAt   DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  properties   LandProperty[]
  ownerships   LandOwnership[]
  transactions LandTransaction[] @relation("LandPlotTransactions")

  @@index([region, district])
  @@index([landType])
  @@index([cadastralNumber])
}

model LandProperty {
  id String @id @default(uuid())

  landPlotId String
  landPlot   LandPlot @relation(fields: [landPlotId], references: [id], onDelete: Cascade)

  // Property details
  propertyType LandPropertyType
  buildingArea Float?
  floors       Int?
  rooms        Int?
  yearBuilt    Int?

  // Utilities
  hasElectricity Boolean @default(false)
  hasWater       Boolean @default(false)
  hasGas         Boolean @default(false)
  hasSewage      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerships   LandOwnership[]
  leases       LandLease[]
  transactions LandTransaction[] @relation("PropertyTransactions")

  @@index([landPlotId])
  @@index([propertyType])
}

model LandOwnership {
  id String @id @default(uuid())

  landPlotId String?
  landPlot   LandPlot? @relation(fields: [landPlotId], references: [id])

  propertyId String?
  property   LandProperty? @relation(fields: [propertyId], references: [id])

  // Owner
  ownerId          String
  owner            User            @relation("LandOwner", fields: [ownerId], references: [id])
  ownershipType    LandOwnershipType
  sharePercentage  Int             @default(100) // 0-100

  // Citizenship verification
  isCitizenVerified Boolean @default(false)

  // Certificate
  certificateNumber String   @unique @default(uuid())
  issuedAt          DateTime @default(now())
  isActive          Boolean  @default(true)

  // Co-owners (if shared)
  coOwners String[] // userIds

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([landPlotId])
  @@index([propertyId])
  @@index([isActive])
}

model LandLease {
  id String @id @default(uuid())

  propertyId String
  property   LandProperty @relation(fields: [propertyId], references: [id])

  // Lessee
  lesseeId          String
  lessee            User   @relation("LandLessee", fields: [lesseeId], references: [id])
  lesseeName        String
  lesseeNationality String

  // Lease terms
  leaseType  LeaseType
  startDate  DateTime
  endDate    DateTime
  monthlyRent Decimal  @db.Decimal(18, 2)
  currency    String   @default("ALTAN")

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@index([lesseeId])
  @@index([isActive])
}

model LandTransaction {
  id String @id @default(uuid())

  type LandTransactionType

  // Property
  landPlotId String?
  landPlot   LandPlot? @relation("LandPlotTransactions", fields: [landPlotId], references: [id])

  propertyId String?
  property   LandProperty? @relation("PropertyTransactions", fields: [propertyId], references: [id])

  // Parties
  sellerId   String
  seller     User   @relation("LandSeller", fields: [sellerId], references: [id])
  buyerId    String
  buyer      User   @relation("LandBuyer", fields: [buyerId], references: [id])
  sellerName String
  buyerName  String

  // Transaction details
  salePrice Decimal             @db.Decimal(18, 2)
  currency  String              @default("ALTAN")
  status    LandTransactionStatus @default(INITIATED)

  // Payment
  paymentTxHash String?   // blockchain transaction
  paidAt        DateTime?

  // Completion
  completedById    String?
  completedAt      DateTime?
  blockchainTxHash String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sellerId])
  @@index([buyerId])
  @@index([landPlotId])
  @@index([propertyId])
  @@index([status])
}
