// This is the Prisma schema file for INOMAD KHURAL / ALTAN platform
// Database: PostgreSQL
// ORM: Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====================================
// CORE USER & IDENTITY
// ====================================

enum UserRole {
  CITIZEN
  LEADER
  ADMIN
}

enum WalletStatus {
  LOCKED
  PENDING
  UNLOCKED
}

model User {
  id            String       @id @default(uuid())
  seatId        String       @unique // On-chain SeatSBT reference
  role          UserRole     @default(CITIZEN)
  walletStatus  WalletStatus @default(LOCKED)
  walletAddress String?      @unique // On-chain wallet address (bound via SeatSBT ownership)

  // Registration Data
  birthPlace     Json? // { country, region, district, city }
  currentAddress Json?
  ethnicity      String[]
  clan           String?

  // Verification State
  verificationStatus VerificationStatus @default(DRAFT)
  isSuperVerified    Boolean            @default(false)
  superVerifiedBy    String? // Seat ID of the Founder Mandate holder

  // Organization membership
  organizationId String?
  organization   Guild?  @relation("OrganizationMembers", fields: [organizationId], references: [id])

  // Relations
  khuralSeats      KhuralSeat[]
  guildMemberships GuildMember[]
  tasksCreated     Task[]        @relation("TaskCreator")
  tasksAssigned    Task[]        @relation("TaskAssignee")
  altanLedger      AltanLedger?

  // Auth Sessions
  sessions AuthSession[]

  // Bank Link (opaque pointer to banking domain)
  bankLink BankLink?

  // Unlock Ceremony
  unlockRequest  UnlockRequest?
  approvalsGiven UnlockApproval[]

  // Verifications received (Standard 3-local rule)
  verificationsReceived Verification[] @relation("TargetUser")
  verificationsIssued   Verification[] @relation("VerifierUser")

  // Transaction History
  sentTransactions     AltanTransaction[] @relation("SentTransactions")
  receivedTransactions AltanTransaction[] @relation("ReceivedTransactions")
  auditLogs            AuditLog[]

  // History & Council
  proposedHistoryVersions KhuralEventVersion[] @relation("HistoryProposer")
  councilVotes            CouncilVote[]        @relation("CouncilVoter")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seatId])
  @@index([organizationId])
  @@index([verificationStatus])
}

enum VerificationStatus {
  DRAFT
  PENDING
  VERIFIED
  REJECTED
}

// ====================================
// AUTH: NONCE & SESSION MANAGEMENT
// ====================================

model AuthNonce {
  id        String   @id @default(uuid())
  address   String
  nonce     String   @unique
  expiresAt DateTime
  consumed  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([address])
  @@index([expiresAt])
}

model AuthSession {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jti          String   @unique // JWT ID for revocation
  refreshToken String?  @unique
  expiresAt    DateTime
  lastUsedAt   DateTime @default(now())
  ipAddress    String?
  userAgent    String?
  isRevoked    Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([jti])
}

// ====================================
// BANK LINK: OPAQUE POINTER (BANKING SECRECY)
// Identity side stores ONLY the fact of bank relationship.
// No financial data (balance, account number, wallet address) here.
// ====================================

model BankLink {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankCode  String // "BANK_OF_SIBERIA", "BANK_OF_ALTAI", etc.
  bankRef   String // Opaque reference — resolvable ONLY by banking module
  status    String   @default("ACTIVE") // ACTIVE, SUSPENDED, CLOSED

  @@index([bankCode])
}

model Verification {
  id String @id @default(uuid())

  targetUserId String
  targetUser   User   @relation("TargetUser", fields: [targetUserId], references: [id])

  verifierUserId String
  verifierUser   User   @relation("VerifierUser", fields: [verifierUserId], references: [id])

  createdAt DateTime @default(now())

  @@unique([targetUserId, verifierUserId])
}

// ====================================
// KHURAL GOVERNANCE SYSTEM
// ====================================

model KhuralGroup {
  id    String      @id @default(uuid())
  level KhuralLevel
  name  String

  // Hierarchy
  parentGroupId String?
  parentGroup   KhuralGroup?  @relation("GroupHierarchy", fields: [parentGroupId], references: [id])
  childGroups   KhuralGroup[] @relation("GroupHierarchy")

  // Seats (always 10)
  seats KhuralSeat[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([level])
  @@index([parentGroupId])
}

enum KhuralLevel {
  ARBAN // 10 people
  ZUUN // 100 people (10 Arbans)
  MYANGAN // 1000 people (10 Zuuns)
  TUMEN // 10000 people (10 Myangans)
}

model KhuralSeat {
  id    String @id @default(uuid())
  index Int // 0-9 (position in circle)

  // Group reference
  groupId String
  group   KhuralGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Occupant (nullable = empty seat)
  occupantUserId String?
  occupant       User?   @relation(fields: [occupantUserId], references: [id])

  // Seat metadata
  isLeaderSeat Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, index]) // Enforce unique seat positions
  @@index([groupId])
  @@index([occupantUserId])
}

// ====================================
// GUILDS & ORGANIZATIONS
// ====================================

model Guild {
  id          String    @id @default(uuid())
  type        GuildType
  name        String
  description String?

  // For profession guilds
  professionId String?
  profession   Profession? @relation(fields: [professionId], references: [id])

  // Members
  members GuildMember[]

  // For organizations
  organizationMembers User[] @relation("OrganizationMembers")

  // Tasks posted by this guild
  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([professionId])
}

enum GuildType {
  CLAN // Kinship-based
  PROFESSION // Skill-based
  ORGANIZATION // Company/cooperative
  GOVERNMENT // State unit
}

model GuildMember {
  id String @id @default(uuid())

  guildId String
  guild   Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role MemberRole @default(MEMBER)

  // Competence / Meritocracy
  professionRank Int? // Visual Rank (1=Wood, 2=Iron, etc.)
  level          Int  @default(1) // 1-100
  xp             Int  @default(0) // Experience Points

  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, userId]) // User can only be in guild once
  @@index([guildId])
  @@index([userId])
}

enum MemberRole {
  MEMBER
  OFFICER
  LEADER
}

// ====================================
// PROFESSIONS SYSTEM
// ====================================

model Profession {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?

  // Associated guild
  guilds Guild[]

  // Tasks requiring this profession
  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

// ====================================
// TASKS & CONTRACTS
// ====================================

model Task {
  id          String @id @default(uuid())
  title       String
  description String

  // Profession requirement
  professionId String?
  profession   Profession? @relation(fields: [professionId], references: [id])

  // Reward
  rewardAltan Decimal @db.Decimal(18, 6)

  // Status
  status TaskStatus @default(OPEN)

  // Assignment
  assignedUserId String?
  assignedUser   User?   @relation("TaskAssignee", fields: [assignedUserId], references: [id])

  // Creator (organization/guild)
  createdByUserId String
  createdBy       User   @relation("TaskCreator", fields: [createdByUserId], references: [id])

  postedByGuildId String?
  postedByGuild   Guild?  @relation(fields: [postedByGuildId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([status])
  @@index([professionId])
  @@index([assignedUserId])
  @@index([postedByGuildId])
}

enum TaskStatus {
  OPEN
  TAKEN
  COMPLETED
  CANCELLED
}

// ====================================
// ALTAN LEDGER (OFF-CHAIN MIRROR)
// ====================================

model AltanLedger {
  id String @id @default(uuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  balance Decimal @default(0) @db.Decimal(18, 6)

  // Sync tracking
  lastSyncedBlock BigInt?
  lastSyncedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model AltanTransaction {
  id String @id @default(uuid())

  // Legacy userId references (kept for backward compat during transition)
  fromUserId String?
  fromUser   User?   @relation("SentTransactions", fields: [fromUserId], references: [id])

  toUserId String?
  toUser   User?   @relation("ReceivedTransactions", fields: [toUserId], references: [id])

  // BankRef-based references (banking secrecy — no identity correlation)
  fromBankRef String?
  toBankRef   String?

  amount Decimal           @db.Decimal(18, 6)
  type   TransactionType
  status TransactionStatus @default(COMPLETED)
  memo   String?

  // On-chain link
  txHash      String?
  blockNumber BigInt?

  createdAt DateTime @default(now())

  @@index([fromUserId])
  @@index([toUserId])
  @@index([fromBankRef])
  @@index([toBankRef])
  @@index([type])
}

enum TransactionType {
  TRANSFER
  MINT
  BURN
  REWARD
  FEE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

// Module C: Audit & History
model AuditLog {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  userId       String?
  action       String // e.g. "auth.login", "altan.transfer"
  resourceType String? // e.g. "User", "AltanTransaction"
  resourceId   String?
  metadata     Json? // Context details
  ipAddress    String?
  userAgent    String?
  hash         String? // Integrity hash 

  user User? @relation(fields: [userId], references: [id])
}

model KhuralEvent {
  id          String          @id @default(uuid())
  date        DateTime        @default(now())
  title       String
  description String
  type        KhuralEventType

  // High-level public status
  isVerified Boolean @default(false)

  // Versioning (The Timeline)
  versions KhuralEventVersion[]

  // Optional relations
  relatedProposalId String?
}

model KhuralEventVersion {
  id      String      @id @default(uuid())
  eventId String
  event   KhuralEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  title       String
  description String

  // Who wrote this history?
  proposedByUserId String
  proposedByUser   User   @relation("HistoryProposer", fields: [proposedByUserId], references: [id])

  // Council Validation
  isApproved Boolean   @default(false)
  approvedAt DateTime?

  votes CouncilVote[]

  createdAt DateTime @default(now())

  @@index([eventId])
}

model CouncilVote {
  id String @id @default(uuid())

  versionId String
  version   KhuralEventVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  voterUserId String
  voterUser   User   @relation("CouncilVoter", fields: [voterUserId], references: [id])

  vote Boolean // true = APPROVE, false = REJECT

  createdAt DateTime @default(now())

  @@unique([versionId, voterUserId])
}

enum KhuralEventType {
  SESSION_START
  DECREE_SIGNED
  APPOINTMENT
  AMENDMENT
  EMERGENCY
}

// ====================================
// MODULE: UNLOCK CEREMONY (SOVEREIGNTY)
// ====================================

model UnlockRequest {
  id String @id @default(uuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status WalletStatus @default(PENDING)

  approvals UnlockApproval[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model UnlockApproval {
  id String @id @default(uuid())

  requestId String
  request   UnlockRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  approverUserId String
  approver       User   @relation(fields: [approverUserId], references: [id])

  createdAt DateTime @default(now())

  @@unique([requestId, approverUserId]) // One approval per user per request
}

// ====================================
// CENTRAL BANK (Fourth Branch of Power)
// Institutional firewall: separate from BankModule
// ====================================

enum CentralBankRole {
  GOVERNOR
  BOARD_MEMBER
}

enum LicenseStatus {
  ACTIVE
  SUSPENDED
  REVOKED
}

enum EmissionType {
  MINT
  BURN
}

model CentralBankOfficer {
  id            String          @id @default(uuid())
  walletAddress String          @unique
  role          CentralBankRole
  name          String?
  appointedAt   DateTime        @default(now())
  revokedAt     DateTime?
  isActive      Boolean         @default(true)

  emissions      EmissionRecord[]
  licenseActions CentralBankLicense[]   @relation("LicenseIssuer")
  policyChanges  MonetaryPolicyChange[]

  @@index([walletAddress])
  @@index([role])
}

model CentralBankLicense {
  id           String        @id @default(uuid())
  bankAddress  String        @unique
  bankCode     String        @unique
  bankName     String
  status       LicenseStatus @default(ACTIVE)
  issuedAt     DateTime      @default(now())
  revokedAt    DateTime?
  revokeReason String?
  txHash       String?

  issuedById String?
  issuedBy   CentralBankOfficer? @relation("LicenseIssuer", fields: [issuedById], references: [id])

  corrAccount CorrAccount?

  @@index([bankCode])
  @@index([status])
}

model CorrAccount {
  id         String             @id @default(uuid())
  licenseId  String             @unique
  license    CentralBankLicense @relation(fields: [licenseId], references: [id])
  accountRef String             @unique
  balance    Decimal            @default(0) @db.Decimal(18, 6)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  emissions EmissionRecord[]

  @@index([accountRef])
}

model EmissionRecord {
  id     String       @id @default(uuid())
  type   EmissionType
  amount Decimal      @db.Decimal(18, 6)
  reason String
  memo   String?

  corrAccountId String?
  corrAccount   CorrAccount? @relation(fields: [corrAccountId], references: [id])

  authorizedById String?
  authorizedBy   CentralBankOfficer? @relation(fields: [authorizedById], references: [id])

  txHash      String?
  blockNumber BigInt?
  status      TransactionStatus @default(COMPLETED)

  createdAt DateTime @default(now())

  @@index([type])
  @@index([corrAccountId])
  @@index([createdAt])
}

model MonetaryPolicy {
  id                 String   @id @default(uuid())
  officialRate       Decimal  @db.Decimal(10, 4)
  reserveRequirement Decimal  @db.Decimal(10, 4)
  dailyEmissionLimit Decimal  @db.Decimal(18, 6)
  isActive           Boolean  @default(true)
  effectiveFrom      DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([isActive])
}

model MonetaryPolicyChange {
  id            String  @id @default(uuid())
  parameter     String
  previousValue String
  newValue      String
  reason        String?

  authorizedById String?
  authorizedBy   CentralBankOfficer? @relation(fields: [authorizedById], references: [id])

  txHash      String?
  effectiveAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([parameter])
  @@index([effectiveAt])
}

// ====================================
// TWO-TYPE ARBAN SYSTEM
// Family Arbans (Legislative/Khural) + Organizational Arbans (Executive/Judicial/Banking)
// ====================================

// ==================== FAMILY ARBAN ====================

model FamilyArban {
  id                 String  @id @default(uuid())
  arbanId            BigInt  @unique // On-chain arban ID
  husbandSeatId      BigInt
  wifeSeatId         BigInt
  heirSeatId         BigInt?
  zunId              BigInt?
  khuralRepSeatId    BigInt?
  khuralRepBirthYear Int?
  isActive           Boolean @default(true)

  // Relations
  children FamilyArbanChild[]
  zun      Zun?               @relation(fields: [zunId], references: [zunId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([husbandSeatId])
  @@index([wifeSeatId])
  @@index([zunId])
  @@index([khuralRepSeatId])
}

model FamilyArbanChild {
  id          String      @id @default(uuid())
  arbanId     BigInt
  familyArban FamilyArban @relation(fields: [arbanId], references: [arbanId], onDelete: Cascade)
  childSeatId BigInt
  addedAt     DateTime    @default(now())

  @@unique([arbanId, childSeatId])
  @@index([arbanId])
  @@index([childSeatId])
}

// ==================== ZUN (CLAN) ====================

model Zun {
  id             String  @id @default(uuid())
  zunId          BigInt  @unique // On-chain zun ID
  name           String
  founderArbanId BigInt
  elderSeatId    BigInt?
  isActive       Boolean @default(true)

  // Relations
  memberArbans FamilyArban[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([founderArbanId])
  @@index([elderSeatId])
}

// ==================== ORGANIZATIONAL ARBAN ====================

enum OrgArbanType {
  NONE
  EXECUTIVE // Government, President administration
  JUDICIAL // Courts, justice system
  BANKING // Central Bank, commercial banks
  PRIVATE_COMPANY // Private businesses
  STATE_COMPANY // State-owned enterprises
  GUILD // Professional guilds
  SCIENTIFIC_COUNCIL // Temple of Heaven - Education
  EKHE_KHURAL // Big Khural - Confederation coordination
}

enum PowerBranchType {
  NONE
  LEGISLATIVE // Khural (Family Arbans)
  EXECUTIVE // President (includes Scientific Council/Education)
  JUDICIAL // Courts
  BANKING // Central Bank
}

model OrganizationalArban {
  id           String          @id @default(uuid())
  arbanId      BigInt          @unique // On-chain arban ID
  name         String
  orgType      OrgArbanType
  powerBranch  PowerBranchType
  parentOrgId  BigInt?
  leaderSeatId BigInt?
  isActive     Boolean         @default(true)

  // Relations
  members     OrgArbanMember[]
  parent      OrganizationalArban?  @relation("OrgHierarchy", fields: [parentOrgId], references: [arbanId])
  departments OrganizationalArban[] @relation("OrgHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgType])
  @@index([powerBranch])
  @@index([parentOrgId])
  @@index([leaderSeatId])
}

model OrgArbanMember {
  id       String              @id @default(uuid())
  arbanId  BigInt
  org      OrganizationalArban @relation(fields: [arbanId], references: [arbanId], onDelete: Cascade)
  seatId   BigInt
  joinedAt DateTime            @default(now())

  @@unique([arbanId, seatId])
  @@index([arbanId])
  @@index([seatId])
}

// ==================== CREDIT SYSTEM ====================

enum CreditLineType {
  NONE
  FAMILY
  ORG
}

model CreditLine {
  id            String         @id @default(uuid())
  arbanId       BigInt         @unique
  creditType    CreditLineType
  creditRating  Int            @default(500) // 0-1000
  creditLimit   Decimal        @db.Decimal(18, 6)
  borrowed      Decimal        @default(0) @db.Decimal(18, 6)
  totalBorrowed Decimal        @default(0) @db.Decimal(18, 6)
  totalRepaid   Decimal        @default(0) @db.Decimal(18, 6)
  defaultCount  Int            @default(0)
  onTimeCount   Int            @default(0)
  isActive      Boolean        @default(true)

  // Relations
  loans Loan[]

  openedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([arbanId])
  @@index([creditType])
  @@index([creditRating])
}

model Loan {
  id          String         @id @default(uuid())
  loanId      BigInt         @unique // On-chain loan ID
  arbanId     BigInt
  creditLine  CreditLine     @relation(fields: [arbanId], references: [arbanId], onDelete: Cascade)
  creditType  CreditLineType
  principal   Decimal        @db.Decimal(18, 6)
  interest    Decimal        @db.Decimal(18, 6)
  dueDate     DateTime
  borrowedAt  DateTime       @default(now())
  repaidAt    DateTime?
  isActive    Boolean        @default(true)
  isDefaulted Boolean        @default(false)

  // On-chain sync
  txHashBorrow String?
  txHashRepay  String?

  @@index([arbanId])
  @@index([creditType])
  @@index([isActive])
  @@index([dueDate])
}

// ==================== TIER DISTRIBUTION ====================

enum TierArbanType {
  NONE
  FAMILY
  ORG
}

model TierDistribution {
  id        String        @id @default(uuid())
  seatId    BigInt
  accountId BigInt
  tier      Int // 1, 2, or 3
  arbanType TierArbanType
  arbanId   BigInt
  amount    Decimal       @db.Decimal(18, 6)

  // Approval workflow
  requestedAt     DateTime  @default(now())
  approved        Boolean   @default(false)
  rejected        Boolean   @default(false)
  approvedBy      String? // Wallet address of banker
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  // On-chain sync
  txHash String?

  @@index([seatId])
  @@index([tier])
  @@index([arbanType])
  @@index([arbanId])
  @@index([approved])
  @@index([rejected])
}

// Track which tiers each seat has received
model TierReceived {
  id         String   @id @default(uuid())
  seatId     BigInt
  tier       Int // 1, 2, or 3
  receivedAt DateTime @default(now())
  amount     Decimal  @db.Decimal(18, 6)
  txHash     String?

  @@unique([seatId, tier]) // Each seat can receive each tier only once
  @@index([seatId])
}
